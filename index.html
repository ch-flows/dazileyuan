<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打字乐园</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        :root {
            /* Main colors - soft gradient color scheme */
            --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --secondary-gradient: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            --success-gradient: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            --error-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            --warning-gradient: linear-gradient(135deg, #fad961 0%, #f76b1c 100%);
            --dark-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            
            /* Background colors */
            --light-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --dark-bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            
            /* Card and component colors - increased contrast in dark mode */
            --card-bg-light: rgba(255, 255, 255, 0.92);
            --card-bg-dark: rgba(35, 35, 55, 0.95);
            
            /* Text colors */
            --text-light: #2d3748;
            --text-dark: #e2e8f0;
            --text-muted-light: #718096;
            --text-muted-dark: #a0aec0;
            
            /* Special effect colors */
            --glow-color: rgba(102, 126, 234, 0.3);
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.3);
            
            /* Animation speeds */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--light-bg);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition-medium);
            overflow-x: hidden;
        }

        body.dark-mode {
            background: var(--dark-bg);
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header style - modified: as a complete card containing title and content */
        .main-card {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg-light);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: var(--transition-medium);
            margin-top: 40px;
            margin-bottom: 40px;
        }

        body.dark-mode .main-card {
            background: var(--card-bg-dark);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow-dark);
        }

        /* Header background section */
        .header-section {
            background: var(--primary-gradient);
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .header-section {
            background: var(--dark-gradient);
        }

        .main-title {
            font-size: 3.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
            margin: 10px 0;
            position: relative;
            background: linear-gradient(to right, #fff 0%, #f6f3e9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .copyright-icon {
            font-size: 1.2rem;
            color: white;
            transition: var(--transition-medium);
            vertical-align: middle;
            margin-left: 5px;
            font-weight: 300;
            opacity: 1;
        }

        .nav-controls {
            position: absolute;
            right: 30px;
            top: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.6rem;
            cursor: pointer;
            color: white;
            transition: var(--transition-medium);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg) scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Content area */
        .content-section {
            padding: 40px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            font-size: 2rem;
            position: relative;
        }

        .section-title i {
            font-size: 2.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(106, 17, 203, 0.1);
        }

        /* Text input area */
        .paste-area {
            width: 100%;
            min-height: 150px;
            padding: 25px;
            border: 2px solid rgba(106, 17, 203, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            resize: vertical;
            margin-bottom: 25px;
            transition: var(--transition-medium);
            color: var(--text-light);
            line-height: 1.8;
        }

        body.dark-mode .paste-area {
            background: rgba(40, 40, 60, 0.9);
            border-color: rgba(106, 17, 203, 0.4);
            color: var(--text-dark);
            border: 2px solid rgba(106, 17, 203, 0.5);
        }

        .paste-area:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 4px var(--glow-color);
            background: white;
        }

        body.dark-mode .paste-area:focus {
            background: rgba(50, 50, 70, 0.95);
            border-color: #6a11cb;
            box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.3);
        }

        .paste-area::placeholder {
            color: var(--text-muted-light);
        }

        body.dark-mode .paste-area::placeholder {
            color: var(--text-muted-dark);
        }

        /* Buttons - modified: reduced to half size */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-medium);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
            justify-content: center;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            z-index: -1;
            border-radius: inherit;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: var(--transition-medium);
            z-index: -1;
            border-radius: inherit;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(106, 17, 203, 0.4);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 126, 95, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 126, 95, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 176, 155, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 176, 155, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        }

        /* Progress bar */
        .progress-container {
            margin-top: 25px;
            background: rgba(106, 17, 203, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        body.dark-mode .progress-container {
            background: rgba(106, 17, 203, 0.1);
            border-color: rgba(106, 17, 203, 0.25);
        }

        .progress-bar {
            height: 12px;
            background: rgba(106, 17, 203, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid rgba(106, 17, 203, 0.15);
        }

        body.dark-mode .progress-bar {
            background: rgba(106, 17, 203, 0.15);
            border-color: rgba(106, 17, 203, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Typing test area - separate card */
        .typing-card {
            background: var(--card-bg-light);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            transition: var(--transition-medium);
            margin-top: 40px;
        }

        .typing-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary-gradient);
            border-radius: 25px 25px 0 0;
        }

        body.dark-mode .typing-card {
            background: var(--card-bg-dark);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow-dark);
        }

        .typing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* Typing display area */
        .typing-display {
            width: 100%;
            background: rgba(255, 255, 255, 0.8);
            padding: 50px 25px 25px 25px; /* Increased top padding for pinyin */
            border-radius: 20px;
            font-size: 2.2rem;
            line-height: 2.5; /* Increased line height for pinyin */
            min-height: 180px;
            max-height: 280px;
            overflow-y: auto;
            overflow-x: visible; /* Allow pinyin to pop out horizontally if needed */
            overflow-wrap: break-word;
            white-space: pre-wrap;
            border: 2px solid rgba(106, 17, 203, 0.1);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            position: relative;
        }

        body.dark-mode .typing-display {
            background: rgba(106, 17, 203, 0.1);
            border-color: rgba(106, 17, 203, 0.25);
        }

        /* Character states */
        .char-waiting {
            color: var(--text-muted-light);
            transition: var(--transition-fast);
            cursor: pointer;
            position: relative;
            padding: 2px 1px;
            border-radius: 3px;
        }

        body.dark-mode .char-waiting {
            color: var(--text-muted-dark);
        }

        .char-correct {
            color: #00b09b;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 176, 155, 0.2);
            animation: pop 0.2s ease;
            cursor: pointer;
            position: relative;
            padding: 2px 1px;
            border-radius: 3px;
        }

        .char-incorrect {
            color: #ff416c;
            font-weight: 700;
            text-decoration: underline;
            text-shadow: 0 2px 4px rgba(255, 65, 108, 0.2);
            position: relative;
            cursor: pointer;
            padding: 2px 1px;
            border-radius: 3px;
        }

        .char-current {
            background: linear-gradient(to right, rgba(106, 17, 203, 0.1), rgba(37, 117, 252, 0.1));
            padding: 4px 2px;
            border-radius: 4px;
            border-bottom: 3px solid #6a11cb;
            animation: pulse 1.5s infinite;
            position: relative;
            cursor: pointer;
            /* Ensure it's always visible on iPad */
            min-width: 24px;
            display: inline-block;
        }

        /* New: Click effect */
        .char-clicked {
            background-color: rgba(106, 17, 203, 0.2) !important;
            transform: scale(1.05);
            transition: transform 0.2s, background-color 0.3s;
        }

        /* New: Speech highlighting */
        .char-speaking {
            background-color: #ffeb3b !important;
            color: #000 !important;
            border-radius: 4px;
            box-shadow: 0 0 8px #ffeb3b;
            transform: scale(1.1);
            z-index: 5;
            transition: all 0.1s ease;
        }
        
        body.dark-mode .char-speaking {
            background-color: #fbc02d !important;
            color: #000 !important;
            box-shadow: 0 0 10px #fbc02d;
        }

        /* New: Pinyin display */
        .pinyin-display {
            position: absolute;
            background: var(--primary-gradient);
            color: white;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            top: -1.2em; /* Position above the character */
            left: 50%;
            transform: translateX(-50%);
            line-height: 1.2;
            text-shadow: none;
        }

        .pinyin-display::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #2575fc transparent transparent transparent; /* Match the bottom of the gradient */
        }

        /* New: Speak button */
        .speak-button {
            position: fixed;
            bottom: 120px;
            right: 50px;
            z-index: 100;
        }

        .speak-btn {
            background: var(--success-gradient) !important;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speak-btn:hover {
            transform: scale(1.05);
        }

        .speak-btn.active {
            animation: pulse 1s infinite;
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(106, 17, 203, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(106, 17, 203, 0); }
        }

        /* Input field */
        .typing-input {
            width: 100%;
            min-height: 100px;
            padding: 20px;
            border: 2px solid rgba(106, 17, 203, 0.2);
            border-radius: 20px;
            font-size: 1.3rem;
            margin-bottom: 25px;
            transition: var(--transition-medium);
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-light);
            resize: vertical;
            line-height: 1.7;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body.dark-mode .typing-input {
            background: rgba(40, 40, 60, 0.9);
            border-color: rgba(106, 17, 203, 0.4);
            color: var(--text-dark);
            border: 2px solid rgba(106, 17, 203, 0.5);
        }

        .typing-input:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 4px var(--glow-color);
            background: white;
        }

        body.dark-mode .typing-input:focus {
            background: rgba(50, 50, 70, 0.95);
            border-color: #6a11cb;
            box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.3);
        }

        .typing-input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: rgba(245, 247, 250, 0.7);
        }

        body.dark-mode .typing-input:disabled {
            background: rgba(40, 40, 60, 0.7);
        }

        /* Statistics cards - improved dark mode borders */
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-box {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.05), 
                rgba(37, 117, 252, 0.05));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: var(--transition-medium);
            border: 1px solid rgba(106, 17, 203, 0.15);
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .stat-box {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.12), 
                rgba(37, 117, 252, 0.12));
            border-color: rgba(106, 17, 203, 0.35);
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary-gradient);
            border-radius: 20px 20px 0 0;
        }

        .stat-box:nth-child(2)::before {
            background: var(--success-gradient);
        }

        .stat-box:nth-child(3)::before {
            background: var(--warning-gradient);
        }

        .stat-box:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-box:nth-child(2) .stat-value {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-box:nth-child(3) .stat-value {
            background: var(--warning-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted-light);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        body.dark-mode .stat-label {
            color: var(--text-muted-dark);
        }

        /* Timer display */
        .timer-display {
            font-size: 1.2rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            padding: 15px;
            border-radius: 15px;
            background-color: rgba(106, 17, 203, 0.05);
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        body.dark-mode .timer-display {
            background-color: rgba(106, 17, 203, 0.1);
            border-color: rgba(106, 17, 203, 0.25);
        }

        /* Countdown */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 12, 41, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            display: none;
        }

        .countdown-number {
            font-size: 10rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 0 40px rgba(255, 255, 255, 0.5);
            animation: countdownPulse 1s infinite;
        }

        @keyframes countdownPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Scoring info button - modified: smaller, moved to bottom right */
        .scoring-info {
            position: fixed;
            bottom: 50px;
            right: 50px;
            z-index: 100;
        }

        .scoring-btn {
            background: var(--warning-gradient) !important;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(250, 217, 97, 0.3);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Scoring table popup */
        .scoring-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-medium);
        }

        .scoring-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .scoring-modal {
            background: var(--card-bg-light);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: modalSlideIn 0.5s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        body.dark-mode .scoring-modal {
            background: var(--card-bg-dark);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .scoring-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(106, 17, 203, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .scoring-header {
            border-bottom-color: rgba(106, 17, 203, 0.25);
        }

        .scoring-header h2 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-light);
        }

        .scoring-header h2 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--text-muted-light);
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-medium);
        }

        .close-btn:hover {
            background: rgba(106, 17, 203, 0.1);
            color: #6a11cb;
            transform: rotate(90deg);
        }

        .scoring-content {
            padding: 20px;
        }

        .scoring-table {
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .scoring-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            border: 1px solid rgba(106, 17, 203, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        body.dark-mode .scoring-table table {
            border-color: rgba(106, 17, 203, 0.25);
        }

        .scoring-table th {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.1), 
                rgba(37, 117, 252, 0.1));
            padding: 12px 15px;
            text-align: left;
            color: var(--text-light);
            font-weight: 600;
            border-bottom: 2px solid rgba(106, 17, 203, 0.3);
            font-size: 0.85rem;
        }

        body.dark-mode .scoring-table th {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.2), 
                rgba(37, 117, 252, 0.2));
            color: var(--text-dark);
            border-bottom-color: rgba(106, 17, 203, 0.4);
        }

        .scoring-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(106, 17, 203, 0.1);
            color: var(--text-light);
        }

        body.dark-mode .scoring-table td {
            color: var(--text-dark);
            border-bottom-color: rgba(106, 17, 203, 0.2);
        }

        .scoring-table tr:hover {
            background: rgba(106, 17, 203, 0.05);
        }

        body.dark-mode .scoring-table tr:hover {
            background: rgba(106, 17, 203, 0.15);
        }

        /* Evaluation badges - reduced size */
        .badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge.excellent {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
        }

        .badge.great {
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            color: white;
        }

        .badge.good {
            background: linear-gradient(135deg, #3494E6, #EC6EAD);
            color: white;
        }

        .badge.average {
            background: linear-gradient(135deg, #fad961, #f76b1c);
            color: white;
        }

        .badge.beginner {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        /* Formula section - reduced font */
        .formula-section {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.05), 
                rgba(37, 117, 252, 0.05));
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }

        body.dark-mode .formula-section {
            background: linear-gradient(135deg, 
                rgba(106, 17, 203, 0.12), 
                rgba(37, 117, 252, 0.12));
            border-color: rgba(106, 17, 203, 0.25);
        }

        .formula-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            color: var(--text-light);
            font-size: 1rem;
        }

        .formula-section h3 i {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .formula p {
            margin: 8px 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        body.dark-mode .formula p {
            color: var(--text-dark);
        }

        /* Tip section - reduced font */
        .tip-section {
            background: linear-gradient(135deg, 
                rgba(0, 176, 155, 0.05), 
                rgba(150, 201, 61, 0.05));
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 176, 155, 0.1);
        }

        body.dark-mode .tip-section {
            background: linear-gradient(135deg, 
                rgba(0, 176, 155, 0.12), 
                rgba(150, 201, 61, 0.12));
            border-color: rgba(0, 176, 155, 0.25);
        }

        .tip-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            color: var(--text-light);
            font-size: 1rem;
        }

        .tip-section h3 i {
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tip-section ul {
            padding-left: 20px;
        }

        .tip-section li {
            margin: 6px 0;
            color: var(--text-light);
            position: relative;
            font-size: 0.9rem;
        }

        body.dark-mode .tip-section li {
            color: var(--text-dark);
        }

        .tip-section li:before {
            content: '✓';
            color: #00b09b;
            font-weight: bold;
            position: absolute;
            left: -20px;
        }

        /* iPad specific optimization */
        @media (hover: none) and (pointer: coarse) {
            .typing-input {
                font-size: 16px !important; /* Prevent iOS auto-zoom */
            }
            
            .typing-display {
                font-size: 1.2rem !important; /* More readable on iPad */
                line-height: 2.2 !important;
                padding: 25px 20px !important;
                margin-bottom: 20px !important;
            }
            
            .char-current {
                border-bottom-width: 4px !important;
                min-width: 28px !important;
                min-height: 32px !important;
                padding: 6px 3px !important;
                margin: 0 1px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                position: relative !important;
                z-index: 5 !important;
            }
            
            .char-waiting, .char-correct, .char-incorrect {
                padding: 4px 2px !important;
                min-width: 24px !important;
                min-height: 28px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                position: relative !important;
            }
            
            /* Ensure current character is always visible */
            .typing-display::-webkit-scrollbar {
                width: 8px;
            }
            
            /* Fix for iPad text selection */
            .typing-display * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
            
            .pinyin-display {
                font-size: 0.7rem !important;
                padding: 3px 6px !important;
                top: -25px !important;
            }
        }

        /* Fix for iPad: ensure typing area has proper touch handling */
        @media (max-width: 1024px) {
            .typing-display {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .char-current {
                animation: none !important; /* Remove animation on mobile for better performance */
                border-bottom: 3px solid #6a11cb !important;
                background: linear-gradient(to right, rgba(106, 17, 203, 0.15), rgba(37, 117, 252, 0.15)) !important;
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-title {
                font-size: 2.5rem;
                flex-direction: column;
                gap: 5px;
            }
            
            .copyright-icon {
                font-size: 1.1rem;
                margin-left: 0;
                margin-top: 5px;
                padding: 8px; /* 增加点击区域 */
                -webkit-tap-highlight-color: rgba(255, 255, 255, 0.3);
            }
            
            .copyright-icon:active {
                transform: scale(1.1);
                opacity: 0.8;
            }
            
            .theme-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.4rem;
            }
            
            .main-card, .typing-card {
                padding: 20px;
                margin: 20px auto;
            }
            
            .header-section {
                padding: 30px 20px;
            }
            
            .content-section {
                padding: 20px;
            }
            
            .stats {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn {
                min-width: 100%;
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            
            .nav-controls {
                position: relative;
                right: 0;
                top: 0;
                margin: 20px auto 0;
            }
            
            .countdown-number {
                font-size: 6rem;
            }
            
            .section-title {
                font-size: 1.6rem;
            }
            
            .section-title i {
                font-size: 2rem;
                width: 50px;
                height: 50px;
            }
            
            .scoring-info, .speak-button {
                bottom: 30px;
                right: 30px;
            }
            
            .speak-button {
                bottom: 100px;
            }
            
            .scoring-btn, .speak-btn {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            .scoring-modal {
                width: 95%;
                max-height: 90vh;
            }
            
            .scoring-header h2 {
                font-size: 1.2rem;
            }
            
            .scoring-content {
                padding: 15px;
            }
            
            .scoring-table th,
            .scoring-table td {
                padding: 10px;
                font-size: 0.8rem;
            }
            
            .badge {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            
            .typing-display {
                padding: 20px;
                font-size: 1.1rem;
                line-height: 2;
            }
        }

        /* Scrollbar beautification */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(106, 17, 203, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
        }

        body.dark-mode ::-webkit-scrollbar-track {
            background: rgba(106, 17, 203, 0.1);
        }
        
        /* 版权提示工具样式 */
        .copyright-tooltip {
            position: fixed;
            z-index: 10001;
            animation: tooltipFadeIn 0.3s ease;
        }
        
        .tooltip-content {
            background: var(--primary-gradient);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            min-width: 200px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .tooltip-content h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .tooltip-content p {
            margin: 8px 0;
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .tooltip-arrow {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #6a11cb;
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* iPad触屏优化 */
        @media (hover: none) and (pointer: coarse) {
            .copyright-tooltip {
                touch-action: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            .tooltip-content {
                padding: 25px;
                font-size: 1.1rem;
                min-width: 250px;
            }
            
            .tooltip-content h3 {
                font-size: 1.5rem;
            }
            
            .tooltip-content p {
                font-size: 1.1rem;
                margin: 12px 0;
            }
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .copyright-tooltip {
                max-width: 90vw;
                left: 50% !important;
                transform: translateX(-50%);
                top: 100px !important;
            }
            
            .tooltip-content {
                min-width: unset;
                width: 100%;
            }
        }
        
        /* 黑暗模式适配 */
        body.dark-mode .tooltip-content {
            background: var(--dark-gradient);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.dark-mode .tooltip-arrow {
            border-bottom-color: #0f0c29;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main card - contains header and content -->
        <div class="main-card">
            <!-- Header section -->
            <div class="header-section">
                <h1 class="main-title">
                    打字乐园
                    <span class="copyright-icon" title="Created by Mr Liu">
                        &copy;
                    </span>
                </h1>
                
                <div class="nav-controls">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="theme-toggle" id="speakUnlockBtn" title="Unlock Speech on iPad">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>

            <!-- Content section -->
            <div class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-paste"></i>
                    Add Practice Text
                </h2>
                
                <textarea class="paste-area" id="customText" placeholder="✨ Paste or type the text you want to practice here..."></textarea>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="startPractice">
                        <i class="fas fa-play-circle"></i>
                        Start Practice
                    </button>
                    <button class="btn btn-secondary" id="clearText">
                        <i class="fas fa-trash-alt"></i>
                        Clear Text
                    </button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text">
                        <span>Text Length: <span id="charCount">0</span> characters</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing practice card - displayed separately -->
        <div class="typing-card" id="typingTest" style="display: none;">
            <h2 class="section-title">
                <i class="fas fa-keyboard"></i>
                Typing Practice
            </h2>
            
            <div class="timer-display">
                ⏱️ Timer: <span id="timerDisplay">0:00</span>
            </div>
            
            <div class="typing-hint" style="margin-bottom: 10px; font-size: 0.85rem; color: var(--text-muted-light); text-align: center; padding: 5px; background: rgba(106, 17, 203, 0.05); border-radius: 8px;">
                <i class="fas fa-mouse-pointer"></i> Click to speak; Double-click to show pinyin
            </div>
            <div class="typing-display" id="typingDisplay">
                <!-- Text will be dynamically displayed here -->
            </div>
            
            <textarea class="typing-input" id="typingInput" placeholder="Start typing..." 
                      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                      rows="3"></textarea>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="speed">0</div>
                    <div class="stat-label">Speed (WPM)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy">--%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="masterIndex">0</div>
                    <div class="stat-label">Master Index</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="restartPractice">
                    <i class="fas fa-redo-alt"></i>
                    Restart
                </button>
            </div>
        </div>
    </div>

    <!-- Speak button -->
    <div class="speak-button" id="speakButton" style="display: none;">
        <button class="btn speak-btn" id="speakAllBtn">
            <i class="fas fa-volume-up"></i>
            Speak All
        </button>
    </div>

    <!-- Scoring table button -->
    <div class="scoring-info">
        <button class="btn scoring-btn" id="scoringInfoBtn">
            <i class="fas fa-info-circle"></i>
            Scoring Standard
        </button>
    </div>

    <!-- Scoring table popup -->
    <div class="scoring-overlay" id="scoringOverlay">
        <div class="scoring-modal">
            <div class="scoring-header">
                <h2><i class="fas fa-star"></i> Typing Speed Scoring Standard</h2>
                <button class="close-btn" id="closeScoringBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="scoring-content">
                <div class="scoring-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Speed (words/min)</th>
                                <th>Base Score</th>
                                <th>Evaluation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>≥ 40</td>
                                <td>100 points</td>
                                <td><span class="badge excellent">Excellent</span></td>
                            </tr>
                            <tr>
                                <td>35-39</td>
                                <td>95 points</td>
                                <td><span class="badge great">Great</span></td>
                            </tr>
                            <tr>
                                <td>30-34</td>
                                <td>90 points</td>
                                <td><span class="badge great">Great</span></td>
                            </tr>
                            <tr>
                                <td>25-29</td>
                                <td>80 points</td>
                                <td><span class="badge good">Good</span></td>
                            </tr>
                            <tr>
                                <td>20-24</td>
                                <td>70 points</td>
                                <td><span class="badge good">Good</span></td>
                            </tr>
                            <tr>
                                <td>15-19</td>
                                <td>60 points</td>
                                <td><span class="badge average">Average</span></td>
                            </tr>
                            <tr>
                                <td>10-14</td>
                                <td>50 points</td>
                                <td><span class="badge average">Average</span></td>
                            </tr>
                            <tr>
                                <td>5-9</td>
                                <td>40-45 points</td>
                                <td><span class="badge beginner">Beginner</span></td>
                            </tr>
                            <tr>
                                <td>1-4</td>
                                <td>20-35 points</td>
                                <td><span class="badge beginner">Beginner</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="formula-section">
                    <h3><i class="fas fa-calculator"></i> Calculation Method</h3>
                    <div class="formula">
                        <p><strong>Final Master Index = Speed Score × Accuracy Rate</strong></p>
                        <p>Example: Speed 20 WPM (70 points) × Accuracy 90% = 63 Master Index</p>
                    </div>
                </div>
                
                <div class="tip-section">
                    <h3><i class="fas fa-lightbulb"></i> Learning Suggestions</h3>
                    <ul>
                        <li>Beginner goal: 10-15 words/minute</li>
                        <li>Intermediate goal: 20-25 words/minute</li>
                        <li>Advanced goal: 30+ words/minute</li>
                        <li>Practice 15 minutes daily for significant progress!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Countdown -->
    <div class="countdown-overlay" id="countdownOverlay">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <script>
        // DOM elements
        const customTextArea = document.getElementById('customText');
        const startPracticeBtn = document.getElementById('startPractice');
        const clearTextBtn = document.getElementById('clearText');
        const typingTestSection = document.getElementById('typingTest');
        const typingDisplay = document.getElementById('typingDisplay');
        const typingInput = document.getElementById('typingInput');
        const themeToggle = document.getElementById('themeToggle');
        const speakUnlockBtn = document.getElementById('speakUnlockBtn');
        const restartPracticeBtn = document.getElementById('restartPractice');
        const progressFill = document.getElementById('progressFill');
        const charCount = document.getElementById('charCount');
        const speedElement = document.getElementById('speed');
        const accuracyElement = document.getElementById('accuracy');
        const masterIndexElement = document.getElementById('masterIndex');
        const timerDisplay = document.getElementById('timerDisplay');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNumber = document.getElementById('countdownNumber');
        const scoringInfoBtn = document.getElementById('scoringInfoBtn');
        const scoringOverlay = document.getElementById('scoringOverlay');
        const closeScoringBtn = document.getElementById('closeScoringBtn');
        const copyrightIcon = document.querySelector('.copyright-icon');
        const speakButton = document.getElementById('speakButton');
        const speakAllBtn = document.getElementById('speakAllBtn');

        // Practice state variables
        let practiceText = "";
        let userInput = "";
        let confirmedInput = "";
        let correctChars = 0;
        let wrongChars = 0;
        let startTime = null;
        let endTime = null;
        let timerInterval = null;
        let elapsedSeconds = 0;
        let isPracticeActive = false;
        let isPracticeCompleted = false;
        let isInComposition = false;
        let compositionValue = "";
        let pendingInput = "";
        
        // New: pinyin and speech related
        let pinyinMap = {}; // Store pinyin for Chinese characters
        let currentPinyinElement = null; // Currently displayed pinyin element
        let clickTimers = {}; // Double-click timers
        let speechSynthesis = window.speechSynthesis || null;
        let lastClickTime = 0; // For preventing text selection
        let lastClickElement = null; // Last clicked element
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; // Detect iOS

        // 语音合成管理器 - 修复版
        const speechManager = {
            isSpeaking: false,
            isUnlocked: false, // 新增：语音解锁状态
            currentSpeech: null,
            lastClickTime: 0,
            clickDebounceTime: 300, // 300ms防抖时间
            highlightedElement: null,
            highlightInterval: null, // 新增：高亮定时器
            currentCharIndex: -1, // 新增：当前高亮字符索引
            
            // 检查是否可以说话
            canSpeak() {
                if (!speechSynthesis) return false;
                
                // 防抖检查：避免快速连续点击
                const now = Date.now();
                if (now - this.lastClickTime < this.clickDebounceTime) {
                    return false;
                }
                
                this.lastClickTime = now;
                return true;
            },
            
            // 解锁语音功能
            unlock() {
                if (!speechSynthesis || this.isUnlocked) return false;
                
                console.log('正在解锁语音功能...');
                
                try {
                    // 播放一个几乎无声的语音来解锁浏览器音频权限
                    const unlockUtterance = new SpeechSynthesisUtterance('');
                    unlockUtterance.volume = 0.001; // 几乎听不到
                    unlockUtterance.lang = 'zh-CN';
                    
                    unlockUtterance.onstart = () => {
                        console.log('语音解锁成功');
                        this.isUnlocked = true;
                    };
                    
                    unlockUtterance.onend = () => {
                        console.log('语音解锁完成');
                        this.isUnlocked = true;
                    };
                    
                    unlockUtterance.onerror = (e) => {
                        console.log('语音解锁失败:', e);
                        // 即使失败，也标记为已解锁（可能用户需要手动点击）
                        setTimeout(() => {
                            this.isUnlocked = true;
                        }, 100);
                    };
                    
                    // 立即尝试解锁
                    speechSynthesis.speak(unlockUtterance);
                    
                    // 设置超时，确保解锁状态
                    setTimeout(() => {
                        if (!this.isUnlocked) {
                            console.log('语音自动解锁超时，标记为已解锁');
                            this.isUnlocked = true;
                        }
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.log('语音解锁异常:', error);
                    // 即使异常也标记为已解锁
                    this.isUnlocked = true;
                    return false;
                }
            },
            
            // 专门针对iOS的解锁方法
            unlockForIOS() {
                if (!speechSynthesis) return false;
                
                // 创建一个非常简短的语音来解锁iOS权限
                try {
                    const utterance = new SpeechSynthesisUtterance('');
                    utterance.volume = 0.01; // 极小的音量
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.1;
                    
                    utterance.onend = () => {
                        console.log('iOS语音解锁成功');
                        this.isUnlocked = true;
                    };
                    
                    utterance.onerror = () => {
                        console.log('iOS语音解锁失败');
                        // 即使失败也标记为已解锁（可能需要用户手动点击）
                        this.isUnlocked = true;
                    };
                    
                    // 立即说话（在用户交互上下文中）
                    speechSynthesis.speak(utterance);
                    
                    // 0.5秒后取消这个静音语音
                    setTimeout(() => {
                        speechSynthesis.cancel();
                        this.isUnlocked = true;
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.log('iOS语音解锁异常:', error);
                    this.isUnlocked = true; // 即使异常也尝试解锁
                    return false;
                }
            },
            
            // 确保语音已解锁
            ensureUnlocked(callback) {
                if (this.isUnlocked) {
                    callback();
                    return;
                }
                
                console.log('语音未解锁，正在尝试解锁...');
                if (isIOS) {
                    // iOS设备使用专门的解锁方法
                    console.log('检测到iOS设备，使用特殊解锁');
                    if (this.unlockForIOS()) {
                        setTimeout(() => {
                            callback();
                        }, 600); // iOS需要更长的延迟
                    } else {
                        // 如果解锁失败，仍然尝试执行
                        setTimeout(() => {
                            this.isUnlocked = true;
                            callback();
                        }, 300);
                    }
                } else {
                    // 非iOS设备使用原有方法
                    if (this.unlock()) {
                        setTimeout(() => {
                            callback();
                        }, 200);
                    } else {
                        callback();
                    }
                }
            },
            
            // 停止当前语音和高亮
            stopSpeech() {
                if (speechSynthesis) {
                    speechSynthesis.cancel();
                }
                this.isSpeaking = false;
                this.currentSpeech = null;
                
                // 清除高亮定时器
                if (this.highlightInterval) {
                    clearInterval(this.highlightInterval);
                    this.highlightInterval = null;
                }
                
                if (speakAllBtn) speakAllBtn.classList.remove('active');
                this.clearHighlight();
            },

            // 清除高亮
            clearHighlight() {
                // 清除所有高亮元素的类
                document.querySelectorAll('.char-speaking').forEach(el => {
                    el.classList.remove('char-speaking');
                });
                
                // 重置引用
                this.highlightedElement = null;
                this.currentCharIndex = -1;
                
                // 额外保险：延迟再清除一次
                setTimeout(() => {
                    document.querySelectorAll('.char-speaking').forEach(el => {
                        el.classList.remove('char-speaking');
                    });
                }, 10);
            },
            
            // 开始说话 - 修复高亮问题
            startSpeech(text, startIndex = 0) {
                if (!speechSynthesis) return;
                
                // 先停止任何正在进行的语音
                this.stopSpeech();
                
                // 延迟一小段时间确保状态正确重置
                setTimeout(() => {
                    this.isSpeaking = true;
                    
                    // 创建语音实例
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // 设置语音参数
                    utterance.lang = 'zh-CN';
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    // 保存当前语音实例
                    this.currentSpeech = utterance;
                    
                    // 中文分词 - 将文本拆分为字符数组
                    const characters = Array.from(text);
                    this.currentCharIndex = -1;
                    
                    utterance.onstart = () => {
                        this.isSpeaking = true;
                        if (speakAllBtn) speakAllBtn.classList.add('active');
                        
                        // 计算高亮间隔，基于文本长度和语速
                        const totalDuration = text.length * 200; // 估计总时长
                        const highlightDuration = Math.max(80, Math.floor(totalDuration / characters.length));
                        
                        // 开始高亮动画
                        this.highlightInterval = setInterval(() => {
                            this.currentCharIndex++;
                            
                            // 清除之前的高亮
                            this.clearHighlight();
                            
                            if (this.currentCharIndex < characters.length) {
                                // 高亮当前字符
                                const element = document.getElementById(`char-${startIndex + this.currentCharIndex}`);
                                if (element) {
                                    element.classList.add('char-speaking');
                                    this.highlightedElement = element;
                                    
                                    // 自动滚动到正在读的字
                                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            } else {
                                // 读完所有字符后，停止定时器
                                if (this.highlightInterval) {
                                    clearInterval(this.highlightInterval);
                                    this.highlightInterval = null;
                                }
                            }
                        }, highlightDuration);
                    };
                    
                    utterance.onend = () => {
                        this.isSpeaking = false;
                        this.currentSpeech = null;
                        if (speakAllBtn) speakAllBtn.classList.remove('active');
                        
                        // 清除定时器
                        if (this.highlightInterval) {
                            clearInterval(this.highlightInterval);
                            this.highlightInterval = null;
                        }
                        
                        // 确保清除所有高亮
                        setTimeout(() => {
                            this.clearHighlight();
                        }, 100);
                    };
                    
                    utterance.onerror = (event) => {
                        console.log('Speech synthesis error:', event);
                        this.isSpeaking = false;
                        this.currentSpeech = null;
                        if (speakAllBtn) speakAllBtn.classList.remove('active');
                        
                        // 清除定时器
                        if (this.highlightInterval) {
                            clearInterval(this.highlightInterval);
                            this.highlightInterval = null;
                        }
                        
                        this.clearHighlight();
                    };
                    
                    // 开始语音合成
                    try {
                        speechSynthesis.speak(utterance);
                    } catch (error) {
                        console.log('Speech synthesis failed:', error);
                        this.isSpeaking = false;
                        this.currentSpeech = null;
                        if (speakAllBtn) speakAllBtn.classList.remove('active');
                        
                        if (this.highlightInterval) {
                            clearInterval(this.highlightInterval);
                            this.highlightInterval = null;
                        }
                        
                        this.clearHighlight();
                    }
                }, 50); // 50ms延迟
            },
            
            // 朗读单个字符
            speakCharacter(char, index) {
                this.ensureUnlocked(() => {
                    if (!this.canSpeak()) return;
                    
                    // 先停止任何正在进行的语音
                    this.stopSpeech();
                    
                    // 延迟确保状态重置
                    setTimeout(() => {
                        this.startSpeech(char, index);
                    }, 50);
                });
            },
            
            // 朗读所有文本
            speakAllText(text) {
                this.ensureUnlocked(() => {
                    if (!this.canSpeak() || !text) return;
                    this.startSpeech(text, 0);
                });
            }
        };

        // 版权信息提示管理器
        const copyrightManager = {
            tooltip: null,
            
            // 显示版权信息
            show() {
                // 停止语音（如果正在播放）
                speechManager.stopSpeech();
                
                // 移除之前的提示（如果存在）
                if (this.tooltip) {
                    this.tooltip.remove();
                    this.tooltip = null;
                    return; // 如果已经显示，则点击后隐藏
                }
                
                // 创建提示元素
                this.tooltip = document.createElement('div');
                this.tooltip.className = 'copyright-tooltip';
                this.tooltip.innerHTML = `
                    <div class="tooltip-content">
                        <h3>打字乐园</h3>
                        <p>Created by Mr Liu</p>
                        <div class="tooltip-arrow"></div>
                    </div>
                `;
                
                // 添加到页面
                document.body.appendChild(this.tooltip);
                
                // 定位在版权图标附近
                const rect = copyrightIcon.getBoundingClientRect();
                this.tooltip.style.position = 'fixed';
                this.tooltip.style.top = (rect.bottom + window.scrollY + 10) + 'px';
                this.tooltip.style.left = (rect.left + window.scrollX - 50) + 'px';
                this.tooltip.style.zIndex = '10001';
                
                // 自动隐藏（5秒后）
                setTimeout(() => {
                    if (this.tooltip && this.tooltip.parentNode) {
                        this.tooltip.remove();
                        this.tooltip = null;
                    }
                }, 5000);
                
                // 点击其他地方也隐藏
                const hideTooltip = (e) => {
                    if (this.tooltip && !this.tooltip.contains(e.target) && e.target !== copyrightIcon) {
                        this.tooltip.remove();
                        this.tooltip = null;
                        document.removeEventListener('click', hideTooltip);
                        document.removeEventListener('touchstart', hideTooltip);
                    }
                };
                
                document.addEventListener('click', hideTooltip);
                document.addEventListener('touchstart', hideTooltip);
            },
            
            // 隐藏版权信息
            hide() {
                if (this.tooltip) {
                    this.tooltip.remove();
                    this.tooltip = null;
                }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Event listeners
            startPracticeBtn.addEventListener('click', startPractice);
            clearTextBtn.addEventListener('click', () => {
                customTextArea.value = "";
                updateCharCount();
            });
            
            themeToggle.addEventListener('click', toggleTheme);
            restartPracticeBtn.addEventListener('click', restartPractice);
            
            // 语音解锁按钮
            speakUnlockBtn.addEventListener('click', () => {
                if (!speechSynthesis) {
                    alert('您的设备不支持语音朗读功能。');
                    return;
                }
                
                // 尝试解锁语音
                speechManager.ensureUnlocked(() => {
                    // 测试朗读
                    speechManager.speakCharacter('测', 0);
                    speakUnlockBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakUnlockBtn.style.background = 'var(--success-gradient)';
                    speakUnlockBtn.title = "语音已解锁";
                    
                    // 显示提示
                    if (isIOS) {
                        alert('✅ iPad语音解锁成功！\n\n现在可以正常使用朗读功能了。\n\n如果仍有问题，请确保：\n1. iPad未处于静音模式\n2. 音量调至合适大小\n3. 重启浏览器再试');
                    } else {
                        alert('✅ 语音解锁成功！');
                    }
                });
            });
            
            customTextArea.addEventListener('input', updateCharCount);
            typingInput.addEventListener('input', handleTypingInput);
            typingInput.addEventListener('keydown', handleKeyDown);
            
            // Improved IME event listeners
            typingInput.addEventListener('compositionstart', handleCompositionStart);
            typingInput.addEventListener('compositionupdate', handleCompositionUpdate);
            typingInput.addEventListener('compositionend', handleCompositionEnd);
            
            // Scoring table event listeners
            scoringInfoBtn.addEventListener('click', openScoringTable);
            closeScoringBtn.addEventListener('click', closeScoringTable);
            
            // Click outside popup to close
            scoringOverlay.addEventListener('click', function(e) {
                if (e.target === scoringOverlay) {
                    closeScoringTable();
                }
            });
            
            // ESC key to close scoring table
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && scoringOverlay.classList.contains('active')) {
                    closeScoringTable();
                }
            });
            
            // Speak all button
            speakAllBtn.addEventListener('click', () => {
                if (!practiceText) return;
                speechManager.speakAllText(practiceText);
            });
            
            // 版权图标点击事件
            copyrightIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                copyrightManager.show();
            });
            
            copyrightIcon.addEventListener('touchstart', function(e) {
                e.preventDefault(); // 防止iPad上的默认行为
                e.stopPropagation();
                copyrightManager.show();
            });
            
            // 添加点击效果
            copyrightIcon.addEventListener('mousedown', function() {
                this.style.transform = 'scale(1.1)';
                this.style.opacity = '0.8';
            });
            
            copyrightIcon.addEventListener('mouseup', function() {
                this.style.transform = '';
                this.style.opacity = '';
            });
            
            copyrightIcon.addEventListener('mouseleave', function() {
                this.style.transform = '';
                this.style.opacity = '';
            });
            
            // Update character count
            updateCharCount();
            
            // Initialize COMPLETE pinyin data
            initCompletePinyinData();
            
            // Prevent text selection on double-click
            typingDisplay.addEventListener('mousedown', function(e) {
                if (e.detail > 1) {
                    e.preventDefault();
                }
            });
            
            typingDisplay.addEventListener('touchstart', function(e) {
                const now = Date.now();
                if (now - lastClickTime < 300) {
                    e.preventDefault();
                }
                lastClickTime = now;
            });
            
            // 检查语音合成支持
            if (!speechSynthesis) {
                console.log('Speech synthesis not supported');
                // 隐藏语音按钮
                speakButton.style.display = 'none';
                speakUnlockBtn.style.display = 'none';
            } else {
                console.log('Speech synthesis is supported');
                console.log('Device is iOS:', isIOS);
                
                // iOS设备：显示使用提示
                if (isIOS) {
                    setTimeout(() => {
                        console.log('显示iOS语音提示');
                        // 更新解锁按钮提示
                        speakUnlockBtn.title = "点击解锁iPad语音";
                        speakUnlockBtn.style.background = 'var(--error-gradient)';
                        
                        // 显示iOS专用提示
                        const iosHint = document.createElement('div');
                        iosHint.style.cssText = `
                            position: fixed;
                            top: 120px;
                            left: 50%;
                            transform: translateX(-50%);
                            background: var(--warning-gradient);
                            color: white;
                            padding: 15px 25px;
                            border-radius: 15px;
                            z-index: 9999;
                            text-align: center;
                            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                            max-width: 90%;
                            font-size: 0.9rem;
                        `;
                        iosHint.innerHTML = `
                            <strong>🔊 iPad语音使用提示：</strong><br>
                            首次使用请先点击右侧<br>
                            <i class="fas fa-volume-up"></i> 按钮解锁语音
                        `;
                        document.body.appendChild(iosHint);
                        
                        // 5秒后自动隐藏
                        setTimeout(() => {
                            if (iosHint.parentNode) {
                                iosHint.style.transition = 'opacity 0.5s';
                                iosHint.style.opacity = '0';
                                setTimeout(() => {
                                    if (iosHint.parentNode) {
                                        iosHint.remove();
                                    }
                                }, 500);
                            }
                        }, 5000);
                    }, 1000);
                }
            }
            
            // 添加工具提示的CSS样式
            const tooltipStyle = document.createElement('style');
            tooltipStyle.textContent = `
                .copyright-tooltip {
                    position: fixed;
                    z-index: 10001;
                    animation: tooltipFadeIn 0.3s ease;
                }
                
                .tooltip-content {
                    background: var(--primary-gradient);
                    color: white;
                    padding: 20px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    position: relative;
                    min-width: 200px;
                    text-align: center;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    backdrop-filter: blur(10px);
                }
                
                .tooltip-content h3 {
                    margin-bottom: 10px;
                    font-size: 1.3rem;
                    font-weight: 600;
                }
                
                .tooltip-content p {
                    margin: 8px 0;
                    font-size: 0.95rem;
                    opacity: 0.9;
                }
                
                .tooltip-arrow {
                    position: absolute;
                    top: -10px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 10px solid transparent;
                    border-right: 10px solid transparent;
                    border-bottom: 10px solid #6a11cb;
                }
                
                @keyframes tooltipFadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                /* iPad触屏优化 */
                @media (hover: none) and (pointer: coarse) {
                    .copyright-tooltip {
                        touch-action: none;
                        -webkit-tap-highlight-color: transparent;
                    }
                    
                    .tooltip-content {
                        padding: 25px;
                        font-size: 1.1rem;
                        min-width: 250px;
                    }
                    
                    .tooltip-content h3 {
                        font-size: 1.5rem;
                    }
                    
                    .tooltip-content p {
                        font-size: 1.1rem;
                        margin: 12px 0;
                    }
                }
                
                /* 响应式调整 */
                @media (max-width: 768px) {
                    .copyright-tooltip {
                        max-width: 90vw;
                        left: 50% !important;
                        transform: translateX(-50%);
                        top: 100px !important;
                    }
                    
                    .tooltip-content {
                        min-width: unset;
                        width: 100%;
                    }
                }
                
                /* 黑暗模式适配 */
                body.dark-mode .tooltip-content {
                    background: var(--dark-gradient);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                }
                
                body.dark-mode .tooltip-arrow {
                    border-bottom-color: #0f0c29;
                }
            `;
            document.head.appendChild(tooltipStyle);
        });

        // Initialize COMPLETE pinyin data with common Chinese characters
        function initCompletePinyinData() {
            // Comprehensive pinyin database with 2000+ common Chinese characters
            pinyinMap = {
                // 常见缺失的字
                '爸': 'bà',
                '瘾': 'yǐn',
                '嗯': 'en',
                '哦': 'ò',
                '啊': 'a',
                '嘛': 'ma',
                '呢': 'ne',
                '了': 'le',
                '的': 'de',
                '地': 'de',
                '得': 'de',
                '着': 'zhe',
                '过': 'guo',
                '啊': 'a',
                
                // 更多常用字
                '妈': 'mā',
                '烦': 'fán',
                '礼': 'lǐ',
                '貌': 'mào',
                '曹': 'cáo',
                '操': 'cāo',
                '糙': 'cāo',
                
                // 扩展拼音数据库
                '阿': 'ā', '爱': 'ài', '安': 'ān', '案': 'àn',
                '八': 'bā', '巴': 'bā', '把': 'bǎ', '吧': 'ba', '白': 'bái',
                '百': 'bǎi', '班': 'bān', '般': 'bān', '板': 'bǎn', '办': 'bàn',
                '半': 'bàn', '帮': 'bāng', '包': 'bāo', '保': 'bǎo', '报': 'bào',
                '抱': 'bào', '杯': 'bēi', '悲': 'bēi', '北': 'běi', '备': 'bèi',
                '背': 'bèi', '被': 'bèi', '本': 'běn', '比': 'bǐ', '笔': 'bǐ',
                '必': 'bì', '毕': 'bì', '边': 'biān', '便': 'biàn', '变': 'biàn',
                '遍': 'biàn', '表': 'biǎo', '别': 'bié', '宾': 'bīn', '冰': 'bīng',
                '并': 'bìng', '病': 'bìng', '波': 'bō', '播': 'bō', '伯': 'bó',
                '博': 'bó', '搏': 'bó', '卜': 'bo', '补': 'bǔ', '不': 'bù',
                '布': 'bù', '步': 'bù', '部': 'bù', '擦': 'cā', '猜': 'cāi',
                '才': 'cái', '材': 'cái', '财': 'cái', '采': 'cǎi', '彩': 'cǎi',
                '菜': 'cài', '参': 'cān', '餐': 'cān', '残': 'cán', '惭': 'cán',
                '惨': 'cǎn', '灿': 'càn', '仓': 'cāng', '苍': 'cāng', '舱': 'cāng',
                '藏': 'cáng', '草': 'cǎo', '册': 'cè', '侧': 'cè', '厕': 'cè',
                '测': 'cè', '策': 'cè', '层': 'céng', '曾': 'céng', '叉': 'chā',
                '插': 'chā', '茶': 'chá', '查': 'chá', '察': 'chá', '差': 'chà',
                '拆': 'chāi', '柴': 'chái', '搀': 'chān', '馋': 'chán', '缠': 'chán',
                '蝉': 'chán', '产': 'chǎn', '铲': 'chǎn', '颤': 'chàn', '昌': 'chāng',
                '长': 'cháng', '肠': 'cháng', '尝': 'cháng', '常': 'cháng', '厂': 'chǎng',
                '场': 'chǎng', '敞': 'chǎng', '畅': 'chàng', '倡': 'chàng', '唱': 'chàng',
                '抄': 'chāo', '超': 'chāo', '朝': 'cháo', '潮': 'cháo', '吵': 'chǎo',
                '炒': 'chǎo', '车': 'chē', '扯': 'chě', '彻': 'chè', '撤': 'chè',
                '尘': 'chén', '臣': 'chén', '沉': 'chén', '辰': 'chén', '陈': 'chén',
                '晨': 'chén', '衬': 'chèn', '称': 'chèn', '趁': 'chèn', '撑': 'chēng',
                '成': 'chéng', '呈': 'chéng', '诚': 'chéng', '承': 'chéng', '城': 'chéng',
                '乘': 'chéng', '程': 'chéng', '惩': 'chéng', '澄': 'chéng', '橙': 'chéng',
                '逞': 'chěng', '秤': 'chèng', '吃': 'chī', '痴': 'chī', '池': 'chí',
                '迟': 'chí', '持': 'chí', '尺': 'chǐ', '齿': 'chǐ', '耻': 'chǐ',
                '斥': 'chì', '赤': 'chì', '翅': 'chì', '充': 'chōng', '冲': 'chōng',
                '虫': 'chóng', '崇': 'chóng', '宠': 'chǒng', '抽': 'chōu', '仇': 'chóu',
                '绸': 'chóu', '愁': 'chóu', '稠': 'chóu', '筹': 'chóu', '酬': 'chóu',
                '丑': 'chǒu', '臭': 'chòu', '出': 'chū', '初': 'chū', '除': 'chú',
                '厨': 'chú', '锄': 'chú', '础': 'chǔ', '储': 'chǔ', '楚': 'chǔ',
                '处': 'chù', '触': 'chù', '川': 'chuān', '穿': 'chuān', '传': 'chuán',
                '船': 'chuán', '喘': 'chuǎn', '串': 'chuàn', '疮': 'chuāng', '窗': 'chuāng',
                '床': 'chuáng', '闯': 'chuǎng', '创': 'chuàng', '吹': 'chuī', '炊': 'chuī',
                '垂': 'chuí', '春': 'chūn', '纯': 'chún', '唇': 'chún', '淳': 'chún',
                '醇': 'chún', '蠢': 'chǔn', '词': 'cí', '祠': 'cí', '慈': 'cí',
                '磁': 'cí', '雌': 'cí', '此': 'cǐ', '次': 'cì', '刺': 'cì',
                '赐': 'cì', '匆': 'cōng', '葱': 'cōng', '聪': 'cōng', '从': 'cóng',
                '丛': 'cóng', '凑': 'còu', '粗': 'cū', '促': 'cù', '醋': 'cù',
                '簇': 'cù', '窜': 'cuàn', '摧': 'cuī', '崔': 'cuī', '催': 'cuī',
                '脆': 'cuì', '悴': 'cuì', '粹': 'cuì', '翠': 'cuì', '村': 'cūn',
                '存': 'cún', '寸': 'cùn', '搓': 'cuō', '措': 'cuò', '错': 'cuò',
                '达': 'dá', '答': 'dá', '打': 'dǎ', '大': 'dà', '呆': 'dāi',
                '歹': 'dǎi', '代': 'dài', '带': 'dài', '待': 'dài', '怠': 'dài',
                '袋': 'dài', '戴': 'dài', '丹': 'dān', '单': 'dān', '担': 'dān',
                '耽': 'dān', '胆': 'dǎn', '旦': 'dàn', '但': 'dàn', '诞': 'dàn',
                '弹': 'dàn', '蛋': 'dàn', '当': 'dāng', '挡': 'dǎng', '党': 'dǎng',
                '荡': 'dàng', '档': 'dàng', '刀': 'dāo', '导': 'dǎo', '岛': 'dǎo',
                '倒': 'dǎo', '祷': 'dǎo', '蹈': 'dǎo', '到': 'dào', '盗': 'dào',
                '悼': 'dào', '道': 'dào', '稻': 'dào', '得': 'dé', '德': 'dé',
                '灯': 'dēng', '登': 'dēng', '等': 'děng', '瞪': 'dèng', '低': 'dī',
                '堤': 'dī', '滴': 'dī', '迪': 'dí', '敌': 'dí', '笛': 'dí',
                '底': 'dǐ', '抵': 'dǐ', '地': 'dì', '弟': 'dì', '帝': 'dì',
                '递': 'dì', '第': 'dì', '颠': 'diān', '典': 'diǎn', '点': 'diǎn',
                '碘': 'diǎn', '电': 'diàn', '店': 'diàn', '垫': 'diàn', '殿': 'diàn',
                '叼': 'diāo', '雕': 'diāo', '吊': 'diào', '钓': 'diào', '调': 'diào',
                '掉': 'diào', '爹': 'diē', '跌': 'diē', '叠': 'dié', '碟': 'dié',
                '蝶': 'dié', '丁': 'dīng', '叮': 'dīng', '盯': 'dīng', '顶': 'dǐng',
                '订': 'dìng', '定': 'dìng', '丢': 'diū', '东': 'dōng', '冬': 'dōng',
                '懂': 'dǒng', '动': 'dòng', '冻': 'dòng', '栋': 'dòng', '洞': 'dòng',
                '都': 'dōu', '兜': 'dōu', '斗': 'dòu', '抖': 'dǒu', '陡': 'dǒu',
                '豆': 'dòu', '逗': 'dòu', '督': 'dū', '毒': 'dú', '独': 'dú',
                '读': 'dú', '堵': 'dǔ', '赌': 'dǔ', '杜': 'dù', '肚': 'dù',
                '度': 'dù', '渡': 'dù', '端': 'duān', '短': 'duǎn', '段': 'duàn',
                '断': 'duàn', '缎': 'duàn', '堆': 'duī', '队': 'duì', '对': 'duì',
                '吨': 'dūn', '蹲': 'dūn', '顿': 'dùn', '多': 'duō', '夺': 'duó',
                '朵': 'duǒ', '躲': 'duǒ', '跺': 'duò', '鹅': 'é', '俄': 'é',
                '额': 'é', '恶': 'è', '饿': 'è', '恩': 'ēn', '而': 'ér',
                '儿': 'ér', '耳': 'ěr', '尔': 'ěr', '二': 'èr', '发': 'fā',
                '罚': 'fá', '法': 'fǎ', '帆': 'fān', '番': 'fān', '翻': 'fān',
                '凡': 'fán', '繁': 'fán', '反': 'fǎn', '返': 'fǎn', '犯': 'fàn',
                '饭': 'fàn', '泛': 'fàn', '范': 'fàn', '方': 'fāng', '芳': 'fāng',
                '防': 'fáng', '妨': 'fáng', '房': 'fáng', '仿': 'fǎng', '访': 'fǎng',
                '纺': 'fǎng', '放': 'fàng', '飞': 'fēi', '非': 'fēi', '啡': 'fēi',
                '肥': 'féi', '匪': 'fěi', '诽': 'fěi', '肺': 'fèi', '废': 'fèi',
                '沸': 'fèi', '费': 'fèi', '分': 'fēn', '芬': 'fēn', '吩': 'fēn',
                '纷': 'fēn', '坟': 'fén', '焚': 'fén', '粉': 'fěn', '份': 'fèn',
                '奋': 'fèn', '愤': 'fèn', '粪': 'fèn', '丰': 'fēng', '风': 'fēng',
                '封': 'fēng', '疯': 'fēng', '峰': 'fēng', '锋': 'fēng', '蜂': 'fēng',
                '冯': 'féng', '逢': 'féng', '缝': 'féng', '讽': 'fěng', '凤': 'fèng',
                '奉': 'fèng', '佛': 'fó', '否': 'fǒu', '夫': 'fū', '肤': 'fū',
                '敷': 'fū', '扶': 'fú', '拂': 'fú', '服': 'fú', '浮': 'fú',
                '符': 'fú', '幅': 'fú', '福': 'fú', '抚': 'fǔ', '辅': 'fǔ',
                '斧': 'fǔ', '府': 'fǔ', '俯': 'fǔ', '腐': 'fǔ', '父': 'fù',
                '付': 'fù', '负': 'fù', '妇': 'fù', '附': 'fù', '咐': 'fù',
                '复': 'fù', '赴': 'fù', '副': 'fù', '傅': 'fù', '富': 'fù',
                '腹': 'fù', '覆': 'fù', '该': 'gāi', '改': 'gǎi', '盖': 'gài',
                '溉': 'gài', '概': 'gài', '干': 'gān', '甘': 'gān', '杆': 'gǎn',
                '赶': 'gǎn', '敢': 'gǎn', '感': 'gǎn', '刚': 'gāng', '钢': 'gāng',
                '缸': 'gāng', '岗': 'gǎng', '港': 'gǎng', '高': 'gāo', '糕': 'gāo',
                '搞': 'gǎo', '稿': 'gǎo', '告': 'gào', '哥': 'gē', '歌': 'gē',
                '搁': 'gē', '割': 'gē', '革': 'gé', '格': 'gé', '葛': 'gé',
                '隔': 'gé', '个': 'gè', '各': 'gè', '给': 'gěi', '根': 'gēn',
                '跟': 'gēn', '更': 'gèng', '耕': 'gēng', '工': 'gōng', '弓': 'gōng',
                '公': 'gōng', '功': 'gōng', '攻': 'gōng', '供': 'gōng', '宫': 'gōng',
                '恭': 'gōng', '躬': 'gōng', '巩': 'gǒng', '拱': 'gǒng', '共': 'gòng',
                '贡': 'gòng', '勾': 'gōu', '沟': 'gōu', '钩': 'gōu', '狗': 'gǒu',
                '构': 'gòu', '购': 'gòu', '够': 'gòu', '估': 'gū', '咕': 'gū',
                '姑': 'gū', '孤': 'gū', '古': 'gǔ', '谷': 'gǔ', '股': 'gǔ',
                '骨': 'gǔ', '鼓': 'gǔ', '固': 'gù', '故': 'gù', '顾': 'gù',
                '瓜': 'guā', '刮': 'guā', '挂': 'guà', '乖': 'guāi', '拐': 'guǎi',
                '怪': 'guài', '关': 'guān', '观': 'guān', '官': 'guān', '冠': 'guān',
                '馆': 'guǎn', '管': 'guǎn', '贯': 'guàn', '惯': 'guàn', '灌': 'guàn',
                '罐': 'guàn', '光': 'guāng', '广': 'guǎng', '归': 'guī', '龟': 'guī',
                '规': 'guī', '轨': 'guǐ', '鬼': 'guǐ', '贵': 'guì', '桂': 'guì',
                '跪': 'guì', '滚': 'gǔn', '棍': 'gùn', '锅': 'guō', '国': 'guó',
                '果': 'guǒ', '过': 'guò', '哈': 'hā', '孩': 'hái', '海': 'hǎi',
                '害': 'hài', '含': 'hán', '寒': 'hán', '喊': 'hǎn', '汉': 'hàn',
                '汗': 'hàn', '旱': 'hàn', '行': 'háng', '航': 'háng', '毫': 'háo',
                '好': 'hǎo', '号': 'hào', '浩': 'hào', '喝': 'hē', '禾': 'hé',
                '合': 'hé', '何': 'hé', '和': 'hé', '河': 'hé', '核': 'hé',
                '荷': 'hé', '盒': 'hé', '贺': 'hè', '褐': 'hè', '黑': 'hēi',
                '嘿': 'hēi', '痕': 'hén', '很': 'hěn', '狠': 'hěn', '恨': 'hèn',
                '哼': 'hēng', '恒': 'héng', '横': 'héng', '衡': 'héng', '轰': 'hōng',
                '哄': 'hǒng', '红': 'hóng', '宏': 'hóng', '洪': 'hóng', '虹': 'hóng',
                '喉': 'hóu', '猴': 'hóu', '后': 'hòu', '厚': 'hòu', '候': 'hòu',
                '呼': 'hū', '忽': 'hū', '狐': 'hú', '胡': 'hú', '壶': 'hú',
                '湖': 'hú', '蝴': 'hú', '糊': 'hú', '虎': 'hǔ', '互': 'hù',
                '护': 'hù', '花': 'huā', '华': 'huá', '滑': 'huá', '化': 'huà',
                '划': 'huà', '话': 'huà', '画': 'huà', '怀': 'huái', '坏': 'huài',
                '欢': 'huān', '还': 'huán', '环': 'huán', '缓': 'huǎn', '幻': 'huàn',
                '唤': 'huàn', '换': 'huàn', '患': 'huàn', '荒': 'huāng', '慌': 'huāng',
                '皇': 'huáng', '黄': 'huáng', '煌': 'huáng', '晃': 'huǎng', '灰': 'huī',
                '挥': 'huī', '辉': 'huī', '回': 'huí', '毁': 'huǐ', '悔': 'huǐ',
                '汇': 'huì', '会': 'huì', '绘': 'huì', '贿': 'huì', '惠': 'huì',
                '慧': 'huì', '昏': 'hūn', '婚': 'hūn', '浑': 'hún', '魂': 'hún',
                '混': 'hùn', '活': 'huó', '火': 'huǒ', '伙': 'huǒ', '或': 'huò',
                '货': 'huò', '获': 'huò', '祸': 'huò', '击': 'jī', '饥': 'jī',
                '机': 'jī', '肌': 'jī', '鸡': 'jī', '积': 'jī', '基': 'jī',
                '激': 'jī', '及': 'jí', '吉': 'jí', '级': 'jí', '极': 'jí',
                '即': 'jí', '急': 'jí', '疾': 'jí', '集': 'jí', '几': 'jǐ',
                '己': 'jǐ', '挤': 'jǐ', '脊': 'jǐ', '计': 'jì', '记': 'jì',
                '纪': 'jì', '技': 'jì', '际': 'jì', '剂': 'jì', '季': 'jì',
                '既': 'jì', '济': 'jì', '继': 'jì', '寄': 'jì', '寂': 'jì',
                '加': 'jiā', '夹': 'jiā', '佳': 'jiā', '家': 'jiā', '嘉': 'jiā',
                '甲': 'jiǎ', '假': 'jiǎ', '价': 'jià', '驾': 'jià', '架': 'jià',
                '嫁': 'jià', '稼': 'jià', '尖': 'jiān', '奸': 'jiān', '坚': 'jiān',
                '间': 'jiān', '肩': 'jiān', '艰': 'jiān', '监': 'jiān', '兼': 'jiān',
                '煎': 'jiān', '拣': 'jiǎn', '俭': 'jiǎn', '捡': 'jiǎn', '检': 'jiǎn',
                '减': 'jiǎn', '剪': 'jiǎn', '简': 'jiǎn', '见': 'jiàn', '件': 'jiàn',
                '建': 'jiàn', '剑': 'jiàn', '健': 'jiàn', '舰': 'jiàn', '渐': 'jiàn',
                '谏': 'jiàn', '践': 'jiàn', '鉴': 'jiàn', '键': 'jiàn', '箭': 'jiàn',
                '江': 'jiāng', '将': 'jiāng', '浆': 'jiāng', '僵': 'jiāng', '疆': 'jiāng',
                '讲': 'jiǎng', '奖': 'jiǎng', '匠': 'jiàng', '降': 'jiàng', '酱': 'jiàng',
                '交': 'jiāo', '郊': 'jiāo', '浇': 'jiāo', '娇': 'jiāo', '骄': 'jiāo',
                '胶': 'jiāo', '教': 'jiāo', '焦': 'jiāo', '角': 'jiǎo', '狡': 'jiǎo',
                '绞': 'jiǎo', '脚': 'jiǎo', '搅': 'jiǎo', '缴': 'jiǎo', '叫': 'jiào',
                '觉': 'jiào', '校': 'jiào', '轿': 'jiào', '较': 'jiào', '阶': 'jiē',
                '皆': 'jiē', '接': 'jiē', '揭': 'jiē', '街': 'jiē', '节': 'jié',
                '劫': 'jié', '杰': 'jié', '洁': 'jié', '结': 'jié', '捷': 'jié',
                '截': 'jié', '竭': 'jié', '姐': 'jiě', '解': 'jiě', '介': 'jiè',
                '戒': 'jiè', '届': 'jiè', '界': 'jiè', '借': 'jiè', '巾': 'jīn',
                '今': 'jīn', '斤': 'jīn', '金': 'jīn', '津': 'jīn', '筋': 'jīn',
                '仅': 'jǐn', '紧': 'jǐn', '锦': 'jǐn', '尽': 'jǐn', '进': 'jìn',
                '近': 'jìn', '劲': 'jìn', '晋': 'jìn', '浸': 'jìn', '禁': 'jìn',
                '京': 'jīng', '经': 'jīng', '惊': 'jīng', '晶': 'jīng', '睛': 'jīng',
                '精': 'jīng', '鲸': 'jīng', '井': 'jǐng', '景': 'jǐng', '警': 'jǐng',
                '净': 'jìng', '径': 'jìng', '竞': 'jìng', '竟': 'jìng', '敬': 'jìng',
                '境': 'jìng', '静': 'jìng', '镜': 'jìng', '究': 'jiū', '纠': 'jiū',
                '九': 'jiǔ', '久': 'jiǔ', '酒': 'jiǔ', '旧': 'jiù', '救': 'jiù',
                '就': 'jiù', '舅': 'jiù', '居': 'jū', '局': 'jú', '菊': 'jú',
                '橘': 'jú', '举': 'jǔ', '矩': 'jǔ', '句': 'jù', '巨': 'jù',
                '拒': 'jù', '具': 'jù', '俱': 'jù', '剧': 'jù', '据': 'jù',
                '距': 'jù', '聚': 'jù', '捐': 'juān', '卷': 'juǎn', '倦': 'juàn',
                '绢': 'juàn', '决': 'jué', '绝': 'jué', '觉': 'jué', '掘': 'jué',
                '爵': 'jué', '军': 'jūn', '均': 'jūn', '君': 'jūn', '俊': 'jùn',
                '峻': 'jùn', '骏': 'jùn', '卡': 'kǎ', '开': 'kāi', '凯': 'kǎi',
                '慨': 'kǎi', '刊': 'kān', '堪': 'kān', '砍': 'kǎn', '看': 'kàn',
                '康': 'kāng', '慷': 'kāng', '扛': 'káng', '抗': 'kàng', '考': 'kǎo',
                '烤': 'kǎo', '靠': 'kào', '科': 'kē', '棵': 'kē', '颗': 'kē',
                '壳': 'ké', '咳': 'ké', '可': 'kě', '渴': 'kě', '克': 'kè',
                '刻': 'kè', '客': 'kè', '课': 'kè', '肯': 'kěn', '垦': 'kěn',
                '恳': 'kěn', '坑': 'kēng', '空': 'kōng', '孔': 'kǒng', '恐': 'kǒng',
                '控': 'kòng', '口': 'kǒu', '扣': 'kòu', '枯': 'kū', '哭': 'kū',
                '苦': 'kǔ', '库': 'kù', '裤': 'kù', '酷': 'kù', '夸': 'kuā',
                '垮': 'kuǎ', '挎': 'kuà', '跨': 'kuà', '块': 'kuài', '快': 'kuài',
                '宽': 'kuān', '款': 'kuǎn', '筐': 'kuāng', '狂': 'kuáng', '旷': 'kuàng',
                '况': 'kuàng', '矿': 'kuàng', '框': 'kuàng', '亏': 'kuī', '葵': 'kuí',
                '愧': 'kuì', '溃': 'kuì', '昆': 'kūn', '困': 'kùn', '扩': 'kuò',
                '括': 'kuò', '阔': 'kuò', '拉': 'lā', '垃': 'lā', '啦': 'la',
                '来': 'lái', '赖': 'lài', '兰': 'lán', '拦': 'lán', '栏': 'lán',
                '蓝': 'lán', '篮': 'lán', '览': 'lǎn', '懒': 'lǎn', '烂': 'làn',
                '滥': 'làn', '郎': 'láng', '狼': 'láng', '廊': 'láng', '朗': 'lǎng',
                '浪': 'làng', '捞': 'lāo', '劳': 'láo', '牢': 'láo', '老': 'lǎo',
                '姥': 'lǎo', '乐': 'lè', '勒': 'lè', '雷': 'léi', '累': 'lèi',
                '类': 'lèi', '泪': 'lèi', '棱': 'léng', '冷': 'lěng', '厘': 'lí',
                '梨': 'lí', '离': 'lí', '理': 'lǐ', '李': 'lǐ', '里': 'lǐ',
                '丽': 'lì', '励': 'lì', '厉': 'lì', '立': 'lì', '粒': 'lì',
                '力': 'lì', '历': 'lì', '利': 'lì', '例': 'lì', '隶': 'lì',
                '栗': 'lì', '连': 'lián', '怜': 'lián', '帘': 'lián', '联': 'lián',
                '廉': 'lián', '脸': 'liǎn', '练': 'liàn', '炼': 'liàn', '恋': 'liàn',
                '链': 'liàn', '良': 'liáng', '凉': 'liáng', '梁': 'liáng', '粮': 'liáng',
                '两': 'liǎng', '亮': 'liàng', '谅': 'liàng', '辆': 'liàng', '量': 'liàng',
                '辽': 'liáo', '疗': 'liáo', '聊': 'liáo', '僚': 'liáo', '了': 'liǎo',
                '料': 'liào', '列': 'liè', '劣': 'liè', '烈': 'liè', '猎': 'liè',
                '裂': 'liè', '邻': 'lín', '林': 'lín', '临': 'lín', '淋': 'lín',
                '灵': 'líng', '铃': 'líng', '陵': 'líng', '零': 'líng', '龄': 'líng',
                '领': 'lǐng', '令': 'lìng', '另': 'lìng', '溜': 'liū', '刘': 'liú',
                '流': 'liú', '留': 'liú', '瘤': 'liú', '柳': 'liǔ', '六': 'liù',
                '龙': 'lóng', '聋': 'lóng', '隆': 'lóng', '垄': 'lǒng', '拢': 'lǒng',
                '楼': 'lóu', '搂': 'lǒu', '漏': 'lòu', '露': 'lù', '卢': 'lú',
                '芦': 'lú', '炉': 'lú', '卤': 'lǔ', '鲁': 'lǔ', '陆': 'lù',
                '录': 'lù', '鹿': 'lù', '碌': 'lù', '路': 'lù', '露': 'lù',
                '驴': 'lǘ', '旅': 'lǚ', '屡': 'lǚ', '律': 'lǜ', '虑': 'lǜ',
                '绿': 'lǜ', '卵': 'luǎn', '乱': 'luàn', '掠': 'lüè', '略': 'lüè',
                '伦': 'lún', '轮': 'lún', '论': 'lùn', '罗': 'luó', '萝': 'luó',
                '逻': 'luó', '锣': 'luó', '箩': 'luó', '骡': 'luó', '螺': 'luó',
                '裸': 'luǒ', '落': 'luò', '麻': 'má', '马': 'mǎ', '码': 'mǎ',
                '蚂': 'mǎ', '骂': 'mà', '吗': 'ma', '埋': 'mái', '买': 'mǎi',
                '迈': 'mài', '麦': 'mài', '卖': 'mài', '脉': 'mài', '蛮': 'mán',
                '满': 'mǎn', '漫': 'màn', '慢': 'màn', '芒': 'máng', '忙': 'máng',
                '盲': 'máng', '茫': 'máng', '猫': 'māo', '毛': 'máo', '矛': 'máo',
                '茅': 'máo', '茂': 'mào', '冒': 'mào', '贸': 'mào', '帽': 'mào',
                '么': 'me', '没': 'méi', '眉': 'méi', '梅': 'méi', '煤': 'méi',
                '霉': 'méi', '每': 'měi', '美': 'měi', '妹': 'mèi', '门': 'mén',
                '闷': 'mèn', '们': 'men', '萌': 'méng', '蒙': 'méng', '猛': 'měng',
                '梦': 'mèng', '眯': 'mī', '迷': 'mí', '谜': 'mí', '米': 'mǐ',
                '秘': 'mì', '密': 'mì', '蜜': 'mì', '眠': 'mián', '绵': 'mián',
                '棉': 'mián', '免': 'miǎn', '勉': 'miǎn', '面': 'miàn', '苗': 'miáo',
                '描': 'miáo', '瞄': 'miáo', '秒': 'miǎo', '妙': 'miào', '庙': 'miào',
                '灭': 'miè', '民': 'mín', '敏': 'mǐn', '名': 'míng', '明': 'míng',
                '鸣': 'míng', '命': 'mìng', '摸': 'mō', '模': 'mó', '膜': 'mó',
                '摩': 'mó', '磨': 'mó', '魔': 'mó', '抹': 'mǒ', '末': 'mò',
                '莫': 'mò', '墨': 'mò', '默': 'mò', '谋': 'móu', '某': 'mǒu',
                '母': 'mǔ', '亩': 'mǔ', '牡': 'mǔ', '姆': 'mǔ', '木': 'mù',
                '目': 'mù', '牧': 'mù', '墓': 'mù', '幕': 'mù', '慕': 'mù',
                '拿': 'ná', '哪': 'nǎ', '那': 'nà', '纳': 'nà', '娜': 'nà',
                '乃': 'nǎi', '奶': 'nǎi', '耐': 'nài', '男': 'nán', '南': 'nán',
                '难': 'nán', '囊': 'náng', '恼': 'nǎo', '脑': 'nǎo', '闹': 'nào',
                '呢': 'ne', '内': 'nèi', '嫩': 'nèn', '能': 'néng', '泥': 'ní',
                '尼': 'ní', '你': 'nǐ', '拟': 'nǐ', '逆': 'nì', '年': 'nián',
                '念': 'niàn', '娘': 'niáng', '鸟': 'niǎo', '尿': 'niào', '捏': 'niē',
                '您': 'nín', '宁': 'níng', '凝': 'níng', '牛': 'niú', '扭': 'niǔ',
                '纽': 'niǔ', '农': 'nóng', '浓': 'nóng', '弄': 'nòng', '奴': 'nú',
                '努': 'nǔ', '怒': 'nù', '女': 'nǚ', '暖': 'nuǎn', '挪': 'nuó',
                '诺': 'nuò', '欧': 'ōu', '偶': 'ǒu', '爬': 'pá', '怕': 'pà',
                '拍': 'pāi', '排': 'pái', '牌': 'pái', '派': 'pài', '攀': 'pān',
                '盘': 'pán', '判': 'pàn', '盼': 'pàn', '旁': 'páng', '胖': 'pàng',
                '抛': 'pāo', '炮': 'pào', '跑': 'pǎo', '泡': 'pào', '胚': 'pēi',
                '陪': 'péi', '培': 'péi', '赔': 'péi', '佩': 'pèi', '配': 'pèi',
                '喷': 'pēn', '盆': 'pén', '捧': 'pěng', '碰': 'pèng', '批': 'pī',
                '披': 'pī', '皮': 'pí', '疲': 'pí', '脾': 'pí', '匹': 'pǐ',
                '僻': 'pì', '片': 'piàn', '骗': 'piàn', '飘': 'piāo', '漂': 'piāo',
                '票': 'piào', '拼': 'pīn', '贫': 'pín', '品': 'pǐn', '乒': 'pīng',
                '平': 'píng', '评': 'píng', '凭': 'píng', '瓶': 'píng', '萍': 'píng',
                '坡': 'pō', '泼': 'pō', '婆': 'pó', '迫': 'pò', '破': 'pò',
                '魄': 'pò', '剖': 'pōu', '扑': 'pū', '铺': 'pū', '仆': 'pú',
                '葡': 'pú', '朴': 'pǔ', '普': 'pǔ', '谱': 'pǔ', '瀑': 'pù',
                '七': 'qī', '妻': 'qī', '凄': 'qī', '期': 'qī', '欺': 'qī',
                '漆': 'qī', '齐': 'qí', '其': 'qí', '奇': 'qí', '骑': 'qí',
                '棋': 'qí', '旗': 'qí', '乞': 'qǐ', '企': 'qǐ', '启': 'qǐ',
                '起': 'qǐ', '气': 'qì', '弃': 'qì', '汽': 'qì', '器': 'qì',
                '恰': 'qià', '千': 'qiān', '迁': 'qiān', '牵': 'qiān', '铅': 'qiān',
                '谦': 'qiān', '签': 'qiān', '前': 'qián', '钱': 'qián', '钳': 'qián',
                '潜': 'qián', '浅': 'qiǎn', '遣': 'qiǎn', '欠': 'qiàn', '枪': 'qiāng',
                '腔': 'qiāng', '强': 'qiáng', '墙': 'qiáng', '抢': 'qiǎng', '悄': 'qiāo',
                '敲': 'qiāo', '桥': 'qiáo', '瞧': 'qiáo', '巧': 'qiǎo', '壳': 'qiào',
                '翘': 'qiào', '切': 'qiē', '茄': 'qié', '且': 'qiě', '窃': 'qiè',
                '亲': 'qīn', '侵': 'qīn', '秦': 'qín', '琴': 'qín', '勤': 'qín',
                '青': 'qīng', '轻': 'qīng', '倾': 'qīng', '清': 'qīng', '情': 'qíng',
                '晴': 'qíng', '请': 'qǐng', '庆': 'qìng', '穷': 'qióng', '秋': 'qiū',
                '丘': 'qiū', '求': 'qiú', '球': 'qiú', '区': 'qū', '曲': 'qū',
                '驱': 'qū', '屈': 'qū', '趋': 'qū', '渠': 'qú', '取': 'qǔ',
                '娶': 'qǔ', '去': 'qù', '趣': 'qù', '圈': 'quān', '权': 'quán',
                '泉': 'quán', '全': 'quán', '拳': 'quán', '犬': 'quǎn', '劝': 'quàn',
                '券': 'quàn', '缺': 'quē', '却': 'què', '雀': 'què', '确': 'què',
                '群': 'qún', '然': 'rán', '燃': 'rán', '染': 'rǎn', '嚷': 'rǎng',
                '让': 'ràng', '饶': 'ráo', '扰': 'rǎo', '绕': 'rào', '热': 'rè',
                '人': 'rén', '仁': 'rén', '忍': 'rěn', '认': 'rèn', '任': 'rèn',
                '扔': 'rēng', '仍': 'réng', '日': 'rì', '荣': 'róng', '容': 'róng',
                '溶': 'róng', '熔': 'róng', '融': 'róng', '柔': 'róu', '肉': 'ròu',
                '如': 'rú', '儒': 'rú', '乳': 'rǔ', '辱': 'rǔ', '入': 'rù',
                '软': 'ruǎn', '锐': 'ruì', '瑞': 'ruì', '润': 'rùn', '若': 'ruò',
                '弱': 'ruò', '撒': 'sā', '洒': 'sǎ', '萨': 'sà', '塞': 'sāi',
                '赛': 'sài', '三': 'sān', '伞': 'sǎn', '散': 'sàn', '桑': 'sāng',
                '嗓': 'sǎng', '丧': 'sàng', '扫': 'sǎo', '色': 'sè', '森': 'sēn',
                '僧': 'sēng', '杀': 'shā', '沙': 'shā', '纱': 'shā', '傻': 'shǎ',
                '啥': 'shá', '筛': 'shāi', '晒': 'shài', '山': 'shān', '删': 'shān',
                '衫': 'shān', '闪': 'shǎn', '陕': 'shǎn', '扇': 'shàn', '善': 'shàn',
                '伤': 'shāng', '商': 'shāng', '赏': 'shǎng', '上': 'shàng', '尚': 'shàng',
                '烧': 'shāo', '梢': 'shāo', '稍': 'shāo', '勺': 'sháo', '少': 'shǎo',
                '绍': 'shào', '哨': 'shào', '奢': 'shē', '蛇': 'shé', '舍': 'shě',
                '设': 'shè', '社': 'shè', '射': 'shè', '涉': 'shè', '摄': 'shè',
                '谁': 'shéi', '申': 'shēn', '伸': 'shēn', '身': 'shēn', '深': 'shēn',
                '神': 'shén', '审': 'shěn', '婶': 'shěn', '甚': 'shèn', '渗': 'shèn',
                '慎': 'shèn', '升': 'shēng', '生': 'shēng', '声': 'shēng', '绳': 'shéng',
                '省': 'shěng', '圣': 'shèng', '胜': 'shèng', '盛': 'shèng', '剩': 'shèng',
                '尸': 'shī', '失': 'shī', '师': 'shī', '诗': 'shī', '施': 'shī',
                '狮': 'shī', '湿': 'shī', '十': 'shí', '什': 'shí', '石': 'shí',
                '时': 'shí', '识': 'shí', '实': 'shí', '拾': 'shí', '食': 'shí',
                '蚀': 'shí', '史': 'shǐ', '使': 'shǐ', '始': 'shǐ', '驶': 'shǐ',
                '士': 'shì', '氏': 'shì', '世': 'shì', '市': 'shì', '示': 'shì',
                '式': 'shì', '事': 'shì', '侍': 'shì', '势': 'shì', '视': 'shì',
                '试': 'shì', '饰': 'shì', '室': 'shì', '是': 'shì', '适': 'shì',
                '逝': 'shì', '释': 'shì', '收': 'shōu', '手': 'shǒu', '守': 'shǒu',
                '首': 'shǒu', '寿': 'shòu', '受': 'shòu', '兽': 'shòu', '售': 'shòu',
                '授': 'shòu', '瘦': 'shòu', '书': 'shū', '抒': 'shū', '叔': 'shū',
                '枢': 'shū', '殊': 'shū', '梳': 'shū', '舒': 'shū', '疏': 'shū',
                '输': 'shū', '蔬': 'shū', '熟': 'shú', '暑': 'shǔ', '属': 'shǔ',
                '鼠': 'shǔ', '数': 'shǔ', '术': 'shù', '束': 'shù', '述': 'shù',
                '树': 'shù', '竖': 'shù', '数': 'shù', '刷': 'shuā', '耍': 'shuǎ',
                '衰': 'shuāi', '摔': 'shuāi', '甩': 'shuǎi', '帅': 'shuài', '栓': 'shuān',
                '双': 'shuāng', '霜': 'shuāng', '爽': 'shuǎng', '谁': 'shuí', '水': 'shuǐ',
                '税': 'shuì', '睡': 'shuì', '顺': 'shùn', '说': 'shuō', '司': 'sī',
                '丝': 'sī', '私': 'sī', '思': 'sī', '斯': 'sī', '撕': 'sī',
                '死': 'sǐ', '四': 'sì', '寺': 'sì', '似': 'sì', '饲': 'sì',
                '松': 'sōng', '耸': 'sǒng', '宋': 'sòng', '送': 'sòng', '诵': 'sòng',
                '搜': 'sōu', '艘': 'sōu', '苏': 'sū', '俗': 'sú', '诉': 'sù',
                '肃': 'sù', '素': 'sù', '速': 'sù', '宿': 'sù', '塑': 'sù',
                '酸': 'suān', '蒜': 'suàn', '算': 'suàn', '虽': 'suī', '随': 'suí',
                '髓': 'suǐ', '岁': 'suì', '碎': 'suì', '穗': 'suì', '孙': 'sūn',
                '损': 'sǔn', '笋': 'sǔn', '缩': 'suō', '所': 'suǒ', '索': 'suǒ',
                '锁': 'suǒ', '他': 'tā', '它': 'tā', '她': 'tā', '塌': 'tā',
                '塔': 'tǎ', '踏': 'tà', '台': 'tái', '抬': 'tái', '太': 'tài',
                '态': 'tài', '泰': 'tài', '摊': 'tān', '贪': 'tān', '坛': 'tán',
                '谈': 'tán', '弹': 'tán', '痰': 'tán', '坦': 'tǎn', '毯': 'tǎn',
                '叹': 'tàn', '炭': 'tàn', '探': 'tàn', '汤': 'tāng', '唐': 'táng',
                '堂': 'táng', '塘': 'táng', '糖': 'táng', '倘': 'tǎng', '躺': 'tǎng',
                '烫': 'tàng', '趟': 'tàng', '涛': 'tāo', '掏': 'tāo', '逃': 'táo',
                '桃': 'táo', '陶': 'táo', '淘': 'táo', '萄': 'táo', '讨': 'tǎo',
                '套': 'tào', '特': 'tè', '疼': 'téng', '腾': 'téng', '梯': 'tī',
                '踢': 'tī', '提': 'tí', '题': 'tí', '蹄': 'tí', '体': 'tǐ',
                '替': 'tì', '天': 'tiān', '添': 'tiān', '田': 'tián', '甜': 'tián',
                '填': 'tián', '挑': 'tiāo', '条': 'tiáo', '调': 'tiáo', '挑': 'tiǎo',
                '跳': 'tiào', '贴': 'tiē', '铁': 'tiě', '厅': 'tīng', '听': 'tīng',
                '亭': 'tíng', '庭': 'tíng', '停': 'tíng', '挺': 'tǐng', '艇': 'tǐng',
                '通': 'tōng', '同': 'tóng', '铜': 'tóng', '童': 'tóng', '统': 'tǒng',
                '桶': 'tǒng', '筒': 'tǒng', '痛': 'tòng', '偷': 'tōu', '头': 'tóu',
                '投': 'tóu', '透': 'tòu', '突': 'tū', '图': 'tú', '徒': 'tú',
                '涂': 'tú', '途': 'tú', '屠': 'tú', '土': 'tǔ', '吐': 'tǔ',
                '兔': 'tù', '团': 'tuán', '推': 'tuī', '腿': 'tuǐ', '退': 'tuì',
                '吞': 'tūn', '拖': 'tuō', '托': 'tuō', '脱': 'tuō', '驼': 'tuó',
                '妥': 'tuǒ', '拓': 'tuò', '挖': 'wā', '哇': 'wa', '娃': 'wá',
                '瓦': 'wǎ', '袜': 'wà', '歪': 'wāi', '外': 'wài', '弯': 'wān',
                '湾': 'wān', '玩': 'wán', '顽': 'wán', '完': 'wán', '碗': 'wǎn',
                '晚': 'wǎn', '万': 'wàn', '汪': 'wāng', '亡': 'wáng', '王': 'wáng',
                '网': 'wǎng', '往': 'wǎng', '忘': 'wàng', '旺': 'wàng', '望': 'wàng',
                '危': 'wēi', '威': 'wēi', '微': 'wēi', '为': 'wéi', '围': 'wéi',
                '违': 'wéi', '唯': 'wéi', '维': 'wéi', '伟': 'wěi', '伪': 'wěi',
                '尾': 'wěi', '委': 'wěi', '卫': 'wèi', '未': 'wèi', '位': 'wèi',
                '味': 'wèi', '胃': 'wèi', '谓': 'wèi', '喂': 'wèi', '慰': 'wèi',
                '温': 'wēn', '文': 'wén', '闻': 'wén', '蚊': 'wén', '稳': 'wěn',
                '问': 'wèn', '翁': 'wēng', '我': 'wǒ', '沃': 'wò', '卧': 'wò',
                '握': 'wò', '乌': 'wū', '污': 'wū', '屋': 'wū', '无': 'wú',
                '吴': 'wú', '五': 'wǔ', '午': 'wǔ', '武': 'wǔ', '舞': 'wǔ',
                '务': 'wù', '物': 'wù', '误': 'wù', '悟': 'wù', '雾': 'wù',
                '西': 'xī', '吸': 'xī', '希': 'xī', '昔': 'xī', '析': 'xī',
                '息': 'xī', '悉': 'xī', '惜': 'xī', '稀': 'xī', '溪': 'xī',
                '锡': 'xī', '熄': 'xī', '习': 'xí', '席': 'xí', '袭': 'xí',
                '洗': 'xǐ', '喜': 'xǐ', '戏': 'xì', '系': 'xì', '细': 'xì',
                '隙': 'xì', '虾': 'xiā', '瞎': 'xiā', '峡': 'xiá', '狭': 'xiá',
                '下': 'xià', '吓': 'xià', '夏': 'xià', '仙': 'xiān', '先': 'xiān',
                '纤': 'xiān', '掀': 'xiān', '鲜': 'xiān', '闲': 'xián', '贤': 'xián',
                '弦': 'xián', '咸': 'xián', '衔': 'xián', '嫌': 'xián', '显': 'xiǎn',
                '险': 'xiǎn', '县': 'xiàn', '现': 'xiàn', '线': 'xiàn', '限': 'xiàn',
                '宪': 'xiàn', '陷': 'xiàn', '馅': 'xiàn', '羡': 'xiàn', '献': 'xiàn',
                '乡': 'xiāng', '相': 'xiāng', '香': 'xiāng', '箱': 'xiāng', '详': 'xiáng',
                '祥': 'xiáng', '响': 'xiǎng', '想': 'xiǎng', '向': 'xiàng', '项': 'xiàng',
                '巷': 'xiàng', '象': 'xiàng', '像': 'xiàng', '橡': 'xiàng', '削': 'xiāo',
                '消': 'xiāo', '销': 'xiāo', '小': 'xiǎo', '晓': 'xiǎo', '孝': 'xiào',
                '校': 'xiào', '笑': 'xiào', '效': 'xiào', '些': 'xiē', '歇': 'xiē',
                '协': 'xié', '邪': 'xié', '胁': 'xié', '斜': 'xié', '谐': 'xié',
                '携': 'xié', '鞋': 'xié', '写': 'xiě', '泄': 'xiè', '泻': 'xiè',
                '卸': 'xiè', '屑': 'xiè', '械': 'xiè', '谢': 'xiè', '心': 'xīn',
                '辛': 'xīn', '欣': 'xīn', '新': 'xīn', '薪': 'xīn', '信': 'xìn',
                '兴': 'xīng', '星': 'xīng', '腥': 'xīng', '刑': 'xíng', '行': 'xíng',
                '形': 'xíng', '型': 'xíng', '醒': 'xǐng', '杏': 'xìng', '姓': 'xìng',
                '幸': 'xìng', '性': 'xìng', '凶': 'xiōng', '兄': 'xiōng', '胸': 'xiōng',
                '雄': 'xióng', '熊': 'xióng', '休': 'xiū', '修': 'xiū', '羞': 'xiū',
                '朽': 'xiǔ', '秀': 'xiù', '袖': 'xiù', '绣': 'xiù', '锈': 'xiù',
                '需': 'xū', '虚': 'xū', '须': 'xū', '徐': 'xú', '许': 'xǔ',
                '序': 'xù', '叙': 'xù', '畜': 'xù', '绪': 'xù', '续': 'xù',
                '絮': 'xù', '蓄': 'xù', '宣': 'xuān', '悬': 'xuán', '旋': 'xuán',
                '选': 'xuǎn', '炫': 'xuàn', '削': 'xuē', '学': 'xué', '雪': 'xuě',
                '血': 'xuè', '寻': 'xún', '巡': 'xún', '询': 'xún', '循': 'xún',
                '训': 'xùn', '讯': 'xùn', '迅': 'xùn', '压': 'yā', '呀': 'ya',
                '押': 'yā', '鸦': 'yā', '鸭': 'yā', '牙': 'yá', '芽': 'yá',
                '崖': 'yá', '哑': 'yǎ', '雅': 'yǎ', '亚': 'yà', '咽': 'yān',
                '烟': 'yān', '淹': 'yān', '延': 'yán', '严': 'yán', '言': 'yán',
                '岩': 'yán', '沿': 'yán', '炎': 'yán', '研': 'yán', '盐': 'yán',
                '颜': 'yán', '掩': 'yǎn', '眼': 'yǎn', '演': 'yǎn', '厌': 'yàn',
                '宴': 'yàn', '艳': 'yàn', '验': 'yàn', '焰': 'yàn', '雁': 'yàn',
                '燕': 'yàn', '央': 'yāng', '殃': 'yāng', '秧': 'yāng', '扬': 'yáng',
                '羊': 'yáng', '阳': 'yáng', '杨': 'yáng', '洋': 'yáng', '仰': 'yǎng',
                '养': 'yǎng', '氧': 'yǎng', '样': 'yàng', '妖': 'yāo', '腰': 'yāo',
                '邀': 'yāo', '摇': 'yáo', '遥': 'yáo', '咬': 'yǎo', '药': 'yào',
                '要': 'yào', '耀': 'yào', '爷': 'yé', '也': 'yě', '野': 'yě',
                '业': 'yè', '叶': 'yè', '页': 'yè', '夜': 'yè', '液': 'yè',
                '一': 'yī', '医': 'yī', '依': 'yī', '仪': 'yí', '宜': 'yí',
                '姨': 'yí', '移': 'yí', '遗': 'yí', '疑': 'yí', '乙': 'yǐ',
                '已': 'yǐ', '以': 'yǐ', '椅': 'yǐ', '义': 'yì', '亿': 'yì',
                '艺': 'yì', '议': 'yì', '亦': 'yì', '异': 'yì', '役': 'yì',
                '译': 'yì', '易': 'yì', '疫': 'yì', '益': 'yì', '谊': 'yì',
                '意': 'yì', '毅': 'yì', '翼': 'yì', '因': 'yīn', '阴': 'yīn',
                '音': 'yīn', '姻': 'yīn', '银': 'yín', '引': 'yǐn', '饮': 'yǐn',
                '隐': 'yǐn', '印': 'yìn', '应': 'yīng', '英': 'yīng', '婴': 'yīng',
                '樱': 'yīng', '鹰': 'yīng', '迎': 'yíng', '盈': 'yíng', '营': 'yíng',
                '蝇': 'yíng', '赢': 'yíng', '影': 'yǐng', '映': 'yìng', '硬': 'yìng',
                '哟': 'yo', '拥': 'yōng', '永': 'yǒng', '勇': 'yǒng', '涌': 'yǒng',
                '用': 'yòng', '优': 'yōu', '忧': 'yōu', '幽': 'yōu', '悠': 'yōu',
                '尤': 'yóu', '由': 'yóu', '邮': 'yóu', '油': 'yóu', '游': 'yóu',
                '友': 'yǒu', '有': 'yǒu', '又': 'yòu', '右': 'yòu', '幼': 'yòu',
                '诱': 'yòu', '于': 'yú', '余': 'yú', '鱼': 'yú', '娱': 'yú',
                '渔': 'yú', '愉': 'yú', '愚': 'yú', '与': 'yǔ', '宇': 'yǔ',
                '羽': 'yǔ', '雨': 'yǔ', '语': 'yǔ', '玉': 'yù', '育': 'yù',
                '浴': 'yù', '预': 'yù', '域': 'yù', '欲': 'yù', '遇': 'yù',
                '御': 'yù', '裕': 'yù', '愈': 'yù', '誉': 'yù', '冤': 'yuān',
                '元': 'yuán', '园': 'yuán', '员': 'yuán', '原': 'yuán', '圆': 'yuán',
                '援': 'yuán', '缘': 'yuán', '源': 'yuán', '远': 'yuǎn', '怨': 'yuàn',
                '院': 'yuàn', '愿': 'yuàn', '约': 'yuē', '月': 'yuè', '悦': 'yuè',
                '阅': 'yuè', '跃': 'yuè', '越': 'yuè', '云': 'yún', '匀': 'yún',
                '允': 'yǔn', '运': 'yùn', '晕': 'yūn', '韵': 'yùn', '孕': 'yùn',
                '杂': 'zá', '灾': 'zāi', '栽': 'zāi', '宰': 'zǎi', '再': 'zài',
                '在': 'zài', '咱': 'zán', '暂': 'zàn', '赞': 'zàn', '脏': 'zāng',
                '葬': 'zàng', '遭': 'zāo', '糟': 'zāo', '早': 'zǎo', '枣': 'zǎo',
                '澡': 'zǎo', '灶': 'zào', '造': 'zào', '噪': 'zào', '燥': 'zào',
                '躁': 'zào', '责': 'zé', '择': 'zé', '泽': 'zé', '贼': 'zéi',
                '怎': 'zěn', '增': 'zēng', '赠': 'zèng', '渣': 'zhā', '扎': 'zhā',
                '轧': 'zhá', '闸': 'zhá', '眨': 'zhǎ', '炸': 'zhà', '榨': 'zhà',
                '摘': 'zhāi', '宅': 'zhái', '窄': 'zhǎi', '债': 'zhài', '沾': 'zhān',
                '粘': 'zhān', '展': 'zhǎn', '占': 'zhàn', '战': 'zhàn', '站': 'zhàn',
                '张': 'zhāng', '章': 'zhāng', '涨': 'zhǎng', '掌': 'zhǎng', '丈': 'zhàng',
                '仗': 'zhàng', '帐': 'zhàng', '胀': 'zhàng', '障': 'zhàng', '招': 'zhāo',
                '找': 'zhǎo', '沼': 'zhǎo', '召': 'zhào', '照': 'zhào', '遮': 'zhē',
                '折': 'zhé', '哲': 'zhé', '者': 'zhě', '这': 'zhè', '浙': 'zhè',
                '针': 'zhēn', '珍': 'zhēn', '真': 'zhēn', '诊': 'zhěn', '阵': 'zhèn',
                '振': 'zhèn', '震': 'zhèn', '镇': 'zhèn', '争': 'zhēng', '征': 'zhēng',
                '挣': 'zhēng', '睁': 'zhēng', '筝': 'zhēng', '蒸': 'zhēng', '整': 'zhěng',
                '正': 'zhèng', '证': 'zhèng', '郑': 'zhèng', '政': 'zhèng', '症': 'zhèng',
                '之': 'zhī', '支': 'zhī', '汁': 'zhī', '芝': 'zhī', '枝': 'zhī',
                '知': 'zhī', '织': 'zhī', '肢': 'zhī', '脂': 'zhī', '蜘': 'zhī',
                '执': 'zhí', '直': 'zhí', '值': 'zhí', '职': 'zhí', '植': 'zhí',
                '殖': 'zhí', '止': 'zhǐ', '只': 'zhǐ', '旨': 'zhǐ', '址': 'zhǐ',
                '纸': 'zhǐ', '指': 'zhǐ', '至': 'zhì', '志': 'zhì', '制': 'zhì',
                '治': 'zhì', '质': 'zhì', '致': 'zhì', '智': 'zhì', '置': 'zhì',
                '中': 'zhōng', '忠': 'zhōng', '终': 'zhōng', '钟': 'zhōng', '肿': 'zhǒng',
                '种': 'zhǒng', '众': 'zhòng', '重': 'zhòng', '州': 'zhōu', '舟': 'zhōu',
                '周': 'zhōu', '洲': 'zhōu', '粥': 'zhōu', '宙': 'zhòu', '昼': 'zhòu',
                '皱': 'zhòu', '骤': 'zhòu', '珠': 'zhū', '株': 'zhū', '诸': 'zhū',
                '猪': 'zhū', '竹': 'zhú', '逐': 'zhú', '主': 'zhǔ', '煮': 'zhǔ',
                '嘱': 'zhǔ', '助': 'zhù', '住': 'zhù', '注': 'zhù', '贮': 'zhù',
                '驻': 'zhù', '柱': 'zhù', '祝': 'zhù', '著': 'zhù', '抓': 'zhuā',
                '爪': 'zhuǎ', '专': 'zhuān', '砖': 'zhuān', '转': 'zhuǎn', '赚': 'zhuàn',
                '庄': 'zhuāng', '装': 'zhuāng', '壮': 'zhuàng', '状': 'zhuàng', '撞': 'zhuàng',
                '追': 'zhuī', '准': 'zhǔn', '捉': 'zhuō', '桌': 'zhuō', '啄': 'zhuó',
                '着': 'zhuó', '姿': 'zī', '资': 'zī', '滋': 'zī', '子': 'zǐ',
                '紫': 'zǐ', '字': 'zì', '自': 'zì', '宗': 'zōng', '综': 'zōng',
                '棕': 'zōng', '踪': 'zōng', '总': 'zǒng', '纵': 'zòng', '走': 'zǒu',
                '奏': 'zòu', '租': 'zū', '足': 'zú', '族': 'zú', '阻': 'zǔ',
                '组': 'zǔ', '祖': 'zǔ', '钻': 'zuān', '嘴': 'zuǐ', '最': 'zuì',
                '罪': 'zuì', '醉': 'zuì', '尊': 'zūn', '遵': 'zūn', '昨': 'zuó',
                '左': 'zuǒ', '作': 'zuò', '坐': 'zuò', '座': 'zuò', '做': 'zuò'
            };
            
            // 强制确保关键字的拼音正确
            pinyinMap['爸'] = 'bà';
            pinyinMap['瘾'] = 'yǐn';
            pinyinMap['曹'] = 'cáo';
            pinyinMap['操'] = 'cāo';
            pinyinMap['糙'] = 'cāo';
            pinyinMap['妈'] = 'mā';
            pinyinMap['烦'] = 'fán';
            pinyinMap['礼'] = 'lǐ';
            pinyinMap['貌'] = 'mào';
            
            console.log("拼音数据库初始化完成，包含字符数:", Object.keys(pinyinMap).length);
            console.log("测试字符拼音:", {
                '爸': pinyinMap['爸'],
                '瘾': pinyinMap['瘾'],
                '曹': pinyinMap['曹'],
                '操': pinyinMap['操']
            });
        }

        // Get pinyin for Chinese character with fallback
        function getPinyin(char) {
            // 特殊字符硬编码（确保这些字一定有拼音）
            const specialChars = {
                '爸': 'bà',
                '瘾': 'yǐn',
                '曹': 'cáo',
                '操': 'cāo',
                '糙': 'cāo',
                '妈': 'mā',
                '烦': 'fán',
                '礼': 'lǐ',
                '貌': 'mào'
            };
            
            // 首先检查特殊字符
            if (specialChars[char]) {
                return specialChars[char];
            }
            
            // 然后检查主数据库
            if (pinyinMap[char]) {
                return pinyinMap[char];
            } else {
                // Fallback: return character itself
                console.log(`Character not found in pinyin database: ${char}`);
                return char;
            }
        }

        // Show pinyin
        function showPinyin(element, char) {
            // Remove previously displayed pinyin
            if (currentPinyinElement) {
                currentPinyinElement.remove();
                currentPinyinElement = null;
            }
            
            // Get pinyin
            const pinyin = getPinyin(char);
            if (!pinyin || pinyin === char) return;
            
            // Create pinyin display element
            const pinyinElement = document.createElement('div');
            pinyinElement.className = 'pinyin-display';
            pinyinElement.textContent = pinyin;
            
            // Add directly to the character element
            element.style.position = 'relative';
            element.appendChild(pinyinElement);
            currentPinyinElement = pinyinElement;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (currentPinyinElement === pinyinElement) {
                    pinyinElement.remove();
                    currentPinyinElement = null;
                }
            }, 3000);
        }

        // Update character count
        function updateCharCount() {
            const text = customTextArea.value;
            charCount.textContent = text.length;
            
            const progress = Math.min((text.length / 500) * 100, 100);
            progressFill.style.width = `${progress}%`;
        }

        // Start practice - removed character limit
        function startPractice() {
            const text = customTextArea.value.trim();
            
            if (!text) {
                alert('请输入要练习的文本！');
                return;
            }
            
            // 在开始练习时解锁语音
            if (speechSynthesis && isIOS) {
                // iOS设备：先提示用户解锁语音
                if (!speechManager.isUnlocked) {
                    const shouldUnlock = confirm('🔊 iPad语音功能\n\n首次使用需要解锁语音功能。\n\n是否现在解锁？\n\n如果跳过，可能无法使用朗读功能。');
                    if (shouldUnlock) {
                        speakUnlockBtn.click();
                        return; // 等待用户解锁后再开始
                    }
                }
            }
            
            practiceText = text;
            
            // Show countdown
            startCountdown(true);
        }

        // Restart practice
        function restartPractice() {
            if (!isPracticeActive) return;
            
            // Show countdown
            startCountdown(false);
        }

        // Start countdown (isNewPractice: true=new practice, false=restart)
        function startCountdown(isNewPractice) {
            countdownOverlay.style.display = 'flex';
            let count = 3;
            
            countdownNumber.textContent = count;
            
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownNumber.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownOverlay.style.display = 'none';
                    
                    if (isNewPractice) {
                        startNewPractice();
                    } else {
                        restartCurrentPractice();
                    }
                }
            }, 1000);
        }

        // Start new practice
        function startNewPractice() {
            userInput = "";
            confirmedInput = "";
            pendingInput = "";
            correctChars = 0;
            wrongChars = 0;
            elapsedSeconds = 0;
            isPracticeActive = true;
            isPracticeCompleted = false;
            isInComposition = false;
            compositionValue = "";
            
            // Show typing practice area
            typingTestSection.style.display = "block";
            
            // Show speak button
            speakButton.style.display = "block";
            
            // Update display text
            updateTypingDisplay();
            
            // Reset input field
            typingInput.value = "";
            typingInput.disabled = false;
            typingInput.placeholder = "Start typing...";
            
            // Reset statistics
            resetStats();
            
            // Start timer
            startTimer();
            
            // Scroll to practice area
            typingTestSection.scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
            
            // Delay focus
            setTimeout(() => {
                typingInput.focus();
                // Ensure current character is visible on iPad
                setTimeout(scrollToCurrentChar, 100);
            }, 100);
        }

        // Restart current practice
        function restartCurrentPractice() {
            userInput = "";
            confirmedInput = "";
            pendingInput = "";
            correctChars = 0;
            wrongChars = 0;
            elapsedSeconds = 0;
            isPracticeActive = true;
            isPracticeCompleted = false;
            isInComposition = false;
            compositionValue = "";
            
            typingInput.value = "";
            typingInput.disabled = false;
            typingInput.placeholder = "Start typing...";
            typingInput.focus();
            
            updateTypingDisplay();
            resetStats();
            
            // Restart timer
            startTimer();
            
            // Ensure current character is visible on iPad
            setTimeout(scrollToCurrentChar, 100);
        }

        // Reset statistics
        function resetStats() {
            speedElement.textContent = "0";
            accuracyElement.textContent = "--%";
            masterIndexElement.textContent = "0";
            timerDisplay.textContent = "0:00";
        }

        // Start timer
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            startTime = new Date();
            endTime = null;
            timerInterval = setInterval(() => {
                const now = new Date();
                elapsedSeconds = Math.floor((now - startTime) / 1000);
                
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Real-time speed update
                if (confirmedInput.length > 0) {
                    updateStats();
                }
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            endTime = new Date();
            if (startTime) {
                elapsedSeconds = Math.floor((endTime - startTime) / 1000);
            }
        }

        // Handle IME composition start
        function handleCompositionStart(e) {
            isInComposition = true;
            compositionValue = typingInput.value;
        }

        // Handle IME composition update
        function handleCompositionUpdate(e) {
            if (isInComposition) {
                compositionValue = typingInput.value;
            }
        }

        // Handle IME composition end
        function handleCompositionEnd(e) {
            isInComposition = false;
            userInput = typingInput.value;
            compositionValue = "";
            
            updateConfirmedInput();
        }

        // Handle keyboard input
        function handleKeyDown(e) {
            // Enter key: prevent default behavior (no line break)
            if (e.key === 'Enter') {
                e.preventDefault();
                return;
            }
            
            if (!isPracticeActive || isPracticeCompleted) return;
            
            // ESC key restart
            if (e.key === 'Escape') {
                e.preventDefault();
                restartPractice();
                return;
            }
            
            // Space key: confirm current input
            if (e.key === ' ' && !isInComposition) {
                e.preventDefault();
                userInput = typingInput.value;
                updateConfirmedInput();
            }
            
            // Backspace key: update display immediately
            if (e.key === 'Backspace' && !isInComposition) {
                setTimeout(() => {
                    userInput = typingInput.value;
                    updateConfirmedInput();
                }, 10);
            }
        }

        // Update confirmed input
        function updateConfirmedInput() {
            // Update confirmed input to current user input
            confirmedInput = userInput;
            
            // Check if input is complete
            checkInputCompletion();
            
            // Update display
            updateTypingDisplay();
            
            // Update statistics
            calculateStats();
            updateStats();
            
            // Ensure current character is visible, especially on iPad
            setTimeout(scrollToCurrentChar, 50);
        }

        // Handle typing input
        function handleTypingInput() {
            if (!isPracticeActive || isPracticeCompleted) return;
            
            userInput = typingInput.value;
            
            // If not in IME composition state, update immediately
            if (!isInComposition) {
                updateConfirmedInput();
            }
        }

        // Check if input is complete
        function checkInputCompletion() {
            // Only consider complete when user has typed all characters
            if (confirmedInput.length >= practiceText.length) {
                // Wait a moment to ensure user won't continue modifying
                setTimeout(() => {
                    if (isPracticeActive && !isPracticeCompleted && 
                        typingInput.value.length >= practiceText.length) {
                        finishPractice();
                    }
                }, 500);
            }
        }

        // Update typing display function - with click events
        function updateTypingDisplay() {
            let displayHTML = "";
            
            for (let i = 0; i < practiceText.length; i++) {
                let char = practiceText[i];
                let charClass = "char-waiting";
                
                // Handle HTML special characters
                if (char === " ") {
                    char = "&nbsp;";
                } else if (char === "<") {
                    char = "&lt;";
                } else if (char === ">") {
                    char = "&gt;";
                } else if (char === "&") {
                    char = "&amp;";
                } else if (char === "\n") {
                    char = "<br>";
                }
                
                // Display confirmed input status
                if (i < confirmedInput.length) {
                    if (confirmedInput[i] === practiceText[i]) {
                        charClass = "char-correct";
                    } else {
                        charClass = "char-incorrect";
                    }
                }
                // Current character being typed
                else if (i === confirmedInput.length && isPracticeActive && !isPracticeCompleted) {
                    charClass = "char-current";
                }
                
                // Add click event for each character
                const charId = `char-${i}`;
                displayHTML += `<span id="${charId}" class="${charClass}" data-index="${i}" data-char="${practiceText[i]}">${char}</span>`;
            }
            
            typingDisplay.innerHTML = displayHTML;
            
            // Add click event listeners to all characters
            for (let i = 0; i < practiceText.length; i++) {
                const charElement = document.getElementById(`char-${i}`);
                if (charElement) {
                    // Remove existing listeners to avoid duplicates
                    charElement.removeEventListener('click', handleCharClick);
                    charElement.removeEventListener('touchstart', handleCharClick);
                    
                    // 添加点击事件
                    charElement.addEventListener('click', handleCharClick);
                    
                    // 添加触摸事件，专门为iPad优化
                    charElement.addEventListener('touchstart', function(e) {
                        // 阻止触摸事件的默认行为（滚动）
                        e.preventDefault();
                        // 立即处理触摸事件
                        handleCharClick(e);
                    }, { passive: false });
                    
                    // Prevent text selection on touch devices
                    charElement.addEventListener('selectstart', function(e) {
                        e.preventDefault();
                        return false;
                    });
                }
            }
            
            // Scroll to current character
            scrollToCurrentChar();
        }

        // Handle character click event - 修复iPad双击问题
        function handleCharClick(event) {
            // 阻止所有默认行为
            event.preventDefault();
            event.stopPropagation();
            
            const element = event.currentTarget;
            const index = parseInt(element.getAttribute('data-index'));
            const char = element.getAttribute('data-char');
            
            // 如果是空格或换行，不处理
            if (char === ' ' || char === '\n' || char === '&nbsp;') return;
            
            // 清除文本选择
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
            
            // 点击效果
            element.classList.add('char-clicked');
            setTimeout(() => {
                element.classList.remove('char-clicked');
            }, 300);
            
            // 清除之前的拼音显示
            if (currentPinyinElement) {
                currentPinyinElement.remove();
                currentPinyinElement = null;
            }
            
            // 检查是否为双击 - 为iPad优化
            const now = Date.now();
            const lastClickTime = clickTimers[index] || 0;
            
            // 关键修复：为触摸设备使用更长的双击检测时间
            const doubleClickDelay = isIOS ? 600 : 300; // iPad用600ms
            
            if (now - lastClickTime < doubleClickDelay && lastClickElement === element) {
                // Double-click: show pinyin ONLY - NO SPEAKING
                showPinyin(element, char);
                
                // Clear timers and prevent any further action
                clickTimers[index] = 0;
                lastClickElement = null;
                
                // IMPORTANT: Prevent the single click action from executing
                // This is the key fix - we need to clear the timeout that would trigger speakCharacter
                if (clickTimers['speakTimeout_' + index]) {
                    clearTimeout(clickTimers['speakTimeout_' + index]);
                    delete clickTimers['speakTimeout_' + index];
                }
                
                // 新增：立即停止任何正在播放的语音
                speechManager.stopSpeech();
                
                return; // Exit early to prevent any other actions
            } else {
                // Single click: set up a delayed speak action
                // This allows us to cancel it if a double-click occurs
                clickTimers[index] = now;
                lastClickElement = element;
                
                // iOS设备特殊处理
                if (isIOS) {
                    // 立即停止所有语音
                    speechManager.stopSpeech();
                    
                    // 使用setTimeout确保在用户交互上下文中执行
                    clickTimers['speakTimeout_' + index] = setTimeout(() => {
                        // 只在这个还是单击时才朗读
                        if (clickTimers[index] === now) {
                            speechManager.ensureUnlocked(() => {
                                speechManager.speakCharacter(char, index);
                            });
                        }
                        
                        // 清理定时器
                        clickTimers[index] = 0;
                        lastClickElement = null;
                        delete clickTimers['speakTimeout_' + index];
                    }, 100); // iOS需要更短的延迟
                } else {
                    // 非iOS设备使用原有逻辑
                    clickTimers['speakTimeout_' + index] = setTimeout(() => {
                        // 只在这个还是单击时才朗读
                        if (clickTimers[index] === now) {
                            speechManager.ensureUnlocked(() => {
                                speechManager.speakCharacter(char, index);
                            });
                        }
                        
                        // 清理定时器
                        clickTimers[index] = 0;
                        lastClickElement = null;
                        delete clickTimers['speakTimeout_' + index];
                    }, doubleClickDelay);
                }
            }
        }

        // Scroll to current character - FIXED for iPad
        function scrollToCurrentChar() {
            if (!isPracticeActive || isPracticeCompleted) return;
            
            const currentCharIndex = confirmedInput.length;
            const currentCharElement = document.getElementById(`char-${currentCharIndex}`);
            
            if (!currentCharElement) return;
            
            // Use requestAnimationFrame to ensure DOM is updated
            requestAnimationFrame(() => {
                // Get container and element positions
                const container = typingDisplay;
                const element = currentCharElement;
                
                // Calculate element position relative to container top
                const elementTop = element.offsetTop;
                const elementHeight = element.offsetHeight;
                const containerHeight = container.clientHeight;
                const containerScrollTop = container.scrollTop;
                
                // Calculate target scroll position (element in middle of container)
                const targetScrollTop = elementTop - (containerHeight / 2) + (elementHeight / 2);
                
                // If current character is not near center of viewport, scroll
                const currentPosition = containerScrollTop;
                const targetPosition = Math.max(0, targetScrollTop);
                
                // Check if scrolling is needed (position difference > 1/4 container height)
                if (Math.abs(currentPosition - targetPosition) > containerHeight / 4) {
                    // On iPad, use smooth scrolling
                    if ('scrollBehavior' in document.documentElement.style) {
                        container.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    } else {
                        // Fallback for older browsers
                        container.scrollTop = targetPosition;
                    }
                }
            });
        }

        // Calculate statistics
        function calculateStats() {
            correctChars = 0;
            wrongChars = 0;
            
            // Only calculate up to actual user input length
            const checkLength = Math.min(confirmedInput.length, practiceText.length);
            
            for (let i = 0; i < checkLength; i++) {
                if (confirmedInput[i] === practiceText[i]) {
                    correctChars++;
                } else {
                    wrongChars++;
                }
            }
            
            // If user input longer than original text, extra characters count as additional errors
            if (confirmedInput.length > practiceText.length) {
                wrongChars += (confirmedInput.length - practiceText.length);
            }
        }

        // Finish practice
        function finishPractice() {
            if (!isPracticeActive) return;
            
            isPracticeCompleted = true;
            stopTimer();
            
            // Disable input field
            typingInput.disabled = true;
            typingInput.placeholder = "Practice Completed";
            
            // Final confirmation of all input
            confirmedInput = typingInput.value;
            calculateStats();
            
            // Update display and statistics
            updateTypingDisplay();
            updateStats();
            
            // Auto-focus restart button
            setTimeout(() => {
                restartPracticeBtn.focus();
            }, 100);
        }

        // Update statistics
        function updateStats() {
            if (!isPracticeActive) {
                return;
            }
            
            // Calculate typing speed (words per minute)
            let speed = 0;
            if (elapsedSeconds > 0 && confirmedInput.length > 0) {
                const chineseWords = Math.round(confirmedInput.length * 0.7);
                speed = Math.round((chineseWords / elapsedSeconds) * 60);
                
                if (speed < 1) speed = 1;
                if (speed > 300) speed = 300;
            }
            speedElement.textContent = speed;
            
            // Calculate accuracy
            if (confirmedInput.length === 0) {
                accuracyElement.textContent = "--%";
                masterIndexElement.textContent = "0";
                return;
            }
            
            let accuracy = 100;
            const totalTyped = correctChars + wrongChars;
            
            if (totalTyped > 0) {
                accuracy = Math.round((correctChars / totalTyped) * 100);
                
                if (accuracy < 0) accuracy = 0;
                if (accuracy > 100) accuracy = 100;
            }
            
            accuracyElement.textContent = `${accuracy}%`;
            
            // Calculate master index
            calculateMasterIndex(speed, accuracy);
        }

        // Calculate master index
        function calculateMasterIndex(speed, accuracy) {
            if (confirmedInput.length === 0) {
                masterIndexElement.textContent = "0";
                return 0;
            }
            
            let speedScore = 0;
            if (speed >= 35) speedScore = 95;
            else if (speed >= 30) speedScore = 90;
            else if (speed >= 25) speedScore = 80;
            else if (speed >= 20) speedScore = 70;
            else if (speed >= 15) speedScore = 60;
            else if (speed >= 10) speedScore = 50;
            else if (speed >= 8) speedScore = 45;
            else if (speed >= 6) speedScore = 40;
            else if (speed >= 4) speedScore = 35;
            else if (speed >= 2) speedScore = 30;
            else if (speed >= 1) speedScore = 20;
            
            const masterIndex = Math.round(speedScore * (accuracy / 100));
            masterIndexElement.textContent = masterIndex;
            
            return masterIndex;
        }

        // Toggle theme
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            setTheme(newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Add theme transition animation
            document.body.style.transition = 'all 0.5s ease';
            setTimeout(() => {
                document.body.style.transition = '';
            }, 500);
        }

        // Set theme
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                themeToggle.title = "Switch to Light Mode";
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                themeToggle.title = "Switch to Dark Mode";
            }
        }

        // Open scoring table
        function openScoringTable() {
            scoringOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close scoring table
        function closeScoringTable() {
            scoringOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>
</body>
</html>
